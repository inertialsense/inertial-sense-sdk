<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SDK: src/inertialSenseBootLoader.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="IS_LOGO_BLACK_F03_email_signature.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SDK
   &#160;<span id="projectnumber">Release 1.8.6</span>
   </div>
   <div id="projectbrief">Communications, logger, and bootloader libraries.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">inertialSenseBootLoader.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="inertial_sense_boot_loader_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">MIT LICENSE</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">Copyright (c) 2014-2022 Inertial Sense, Inc. - http://inertialsense.com</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files(the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions :</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;math.h&gt;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="inertial_sense_boot_loader_8h.html">inertialSenseBootLoader.h</a>&quot;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_i_s_constants_8h.html">ISConstants.h</a>&quot;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_i_s_utilities_8h.html">ISUtilities.h</a>&quot;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a5ec11ef11aace0f302a1ea711388a28b">   19</a></span>&#160;<span class="preprocessor">#define MAX_SEND_COUNT 510</span></div><div class="line"><a name="l00020"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a4c548c41044465fad00d24c99eeced77">   20</a></span>&#160;<span class="preprocessor">#define MAX_VERIFY_CHUNK_SIZE 1024</span></div><div class="line"><a name="l00021"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">   21</a></span>&#160;<span class="preprocessor">#define BOOTLOADER_TIMEOUT_DEFAULT 1000</span></div><div class="line"><a name="l00022"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a97c6b46fb3f7fa2d7e62961e3f94d374">   22</a></span>&#160;<span class="preprocessor">#define SAM_BA_BAUDRATE 115200</span></div><div class="line"><a name="l00023"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">   23</a></span>&#160;<span class="preprocessor">#define SAM_BA_FLASH_PAGE_SIZE 512</span></div><div class="line"><a name="l00024"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a9bab5e89643dedb225c44447a84b4eab">   24</a></span>&#160;<span class="preprocessor">#define SAM_BA_FLASH_START_ADDRESS 0x00400000</span></div><div class="line"><a name="l00025"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#abac28520efbc61d0cb08abc48263753c">   25</a></span>&#160;<span class="preprocessor">#define SAM_BA_BOOTLOADER_SIZE 16384</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a20f86ac37b1c9b112cbfd1bfc0598c71">   27</a></span>&#160;<span class="preprocessor">#define X_SOH 0x01</span></div><div class="line"><a name="l00028"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a6260fbddc4df59f2e92d06ef33120d9d">   28</a></span>&#160;<span class="preprocessor">#define X_EOT 0x04</span></div><div class="line"><a name="l00029"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#ace562d0cb6579fea3bd3fd1da60e0a4f">   29</a></span>&#160;<span class="preprocessor">#define X_ACK 0x06</span></div><div class="line"><a name="l00030"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a4c1c7377d676d6e2f1b266f558e1c7f7">   30</a></span>&#160;<span class="preprocessor">#define X_NAK 0x15</span></div><div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a1367e9ae908165cc92e4eeb9f164527b">   31</a></span>&#160;<span class="preprocessor">#define X_CAN 0x18</span></div><div class="line"><a name="l00032"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a3a57af5c3275b2f53fa64274b11e8d52">   32</a></span>&#160;<span class="preprocessor">#define CRC_POLY 0x1021</span></div><div class="line"><a name="l00033"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a828559991c62edd71cbe0bd8034087bb">   33</a></span>&#160;<span class="preprocessor">#define XMODEM_PAYLOAD_SIZE 128</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">// logical page size, offsets for pages are 0x0000 to 0xFFFF - flash page size on devices will vary and is not relevant to the bootloader client</span></div><div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">   36</a></span>&#160;<span class="preprocessor">#define FLASH_PAGE_SIZE 65536</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloadUpdateBootloaderSendFile(<a class="code" href="structbootload__params__t.html">bootload_params_t</a>* p);</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno"><a class="line" href="structbootloader__state__t.html">   40</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;{</div><div class="line"><a name="l00042"></a><span class="lineno"><a class="line" href="structbootloader__state__t.html#abbaaea17b31dcecfd7f5e9b9548d1626">   42</a></span>&#160;    <span class="keywordtype">int</span> <a class="code" href="structbootloader__state__t.html#abbaaea17b31dcecfd7f5e9b9548d1626">version</a>;</div><div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">   43</a></span>&#160;    <span class="keywordtype">int</span> <a class="code" href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">firstPageSkipBytes</a>;</div><div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="structbootloader__state__t.html#a5349b92ca1d8e6d4c7849c81cfce6e44">   44</a></span>&#160;    <span class="keywordtype">int</span> <a class="code" href="structbootloader__state__t.html#a5349b92ca1d8e6d4c7849c81cfce6e44">verifyChunkSize</a>;</div><div class="line"><a name="l00045"></a><span class="lineno"><a class="line" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">   45</a></span>&#160;    <a class="code" href="structbootload__params__t.html">bootload_params_t</a>* <a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;} <a class="code" href="structbootloader__state__t.html">bootloader_state_t</a>;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<a class="code" href="_i_s_constants_8h.html#a5cf8424fec96baad5919dfb1c4a8dc71">PUSH_PACK_1</a></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno"><a class="line" href="structxmodem__chunk__t.html">   50</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;{</div><div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="structxmodem__chunk__t.html#a7a2ab607af54ab9ea0dc8606350b916b">   52</a></span>&#160;    uint8_t <a class="code" href="structxmodem__chunk__t.html#a7a2ab607af54ab9ea0dc8606350b916b">start</a>;</div><div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="structxmodem__chunk__t.html#a54cbea1a5a2bf6d38f3fdd4dc1210588">   53</a></span>&#160;    uint8_t <a class="code" href="structxmodem__chunk__t.html#a54cbea1a5a2bf6d38f3fdd4dc1210588">block</a>;</div><div class="line"><a name="l00054"></a><span class="lineno"><a class="line" href="structxmodem__chunk__t.html#a08365679b65dbfa8c81f293fcd8f36bc">   54</a></span>&#160;    uint8_t <a class="code" href="structxmodem__chunk__t.html#a08365679b65dbfa8c81f293fcd8f36bc">block_neg</a>;</div><div class="line"><a name="l00055"></a><span class="lineno"><a class="line" href="structxmodem__chunk__t.html#af7eb843c4fbc37134142cf71271f1e42">   55</a></span>&#160;    uint8_t payload[<a class="code" href="inertial_sense_boot_loader_8c.html#a828559991c62edd71cbe0bd8034087bb">XMODEM_PAYLOAD_SIZE</a>];</div><div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="structxmodem__chunk__t.html#ac8e4ae3c656fb62e025100bcb3be1af7">   56</a></span>&#160;    uint16_t <a class="code" href="structxmodem__chunk__t.html#ac8e4ae3c656fb62e025100bcb3be1af7">crc</a>;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;} <a class="code" href="structxmodem__chunk__t.html">xmodem_chunk_t</a>;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<a class="code" href="_i_s_constants_8h.html#a2149ebad4d6576b844e9c8ec46e63247">POP_PACK</a></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#if PLATFORM_IS_WINDOWS</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor">#define bootloader_snprintf _snprintf</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">   67</a></span>&#160;<span class="preprocessor">#define bootloader_snprintf snprintf</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">   71</a></span>&#160;<span class="preprocessor">#define bootloader_perror(s, ...) \</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="preprocessor">    if ((s)-&gt;error != 0 &amp;&amp; BOOTLOADER_ERROR_LENGTH &gt; 0) \</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="preprocessor">    { \</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="preprocessor">        bootloader_snprintf((s)-&gt;error + strlen((s)-&gt;error), BOOTLOADER_ERROR_LENGTH - strlen((s)-&gt;error), __VA_ARGS__); \</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="preprocessor">    }</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a9f2d5fb9b4f02d9e5c7627bb1195c856">   77</a></span>&#160;<span class="preprocessor">#define bootloader_min(a, b) (a &lt; b ? a : b)</span></div><div class="line"><a name="l00078"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8c.html#a6c1bfff95bfbb2d369f6f137f7f3a8a8">   78</a></span>&#160;<span class="preprocessor">#define bootloader_max(a, b) (a &gt; b ? a : b)</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hexLookupTable[16] = { <span class="charliteral">&#39;0&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;3&#39;</span>, <span class="charliteral">&#39;4&#39;</span>, <span class="charliteral">&#39;5&#39;</span>, <span class="charliteral">&#39;6&#39;</span>, <span class="charliteral">&#39;7&#39;</span>, <span class="charliteral">&#39;8&#39;</span>, <span class="charliteral">&#39;9&#39;</span>, <span class="charliteral">&#39;A&#39;</span>, <span class="charliteral">&#39;B&#39;</span>, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;D&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;F&#39;</span> };</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">// Fastest to slowest</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> s_baudRateList[] = { <a class="code" href="inertial_sense_boot_loader_8h.html#a9be7e1b986a632f484f90d4a62b93489">IS_BAUD_RATE_BOOTLOADER</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#a404c96d6000a762c614a00847fd6a821">IS_BAUD_RATE_BOOTLOADER_LEGACY</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#a7012a6cc174590fc4e38331c34c5d63d">IS_BAUD_RATE_BOOTLOADER_RS232</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#a3dd40c53dede7af6b3ef8ac95805fd41">IS_BAUD_RATE_BOOTLOADER_SLOW</a> };</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="keyword">static</span> uint16_t crc_update(uint16_t crc_in, <span class="keywordtype">int</span> incr)</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;{</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    uint16_t crc = crc_in &gt;&gt; 15;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    uint16_t out = crc_in &lt;&lt; 1;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="keywordflow">if</span> (incr)</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    {</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        out++;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    }</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="keywordflow">if</span> (crc)</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    {</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        out ^= <a class="code" href="inertial_sense_boot_loader_8c.html#a3a57af5c3275b2f53fa64274b11e8d52">CRC_POLY</a>;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    }</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="keywordflow">return</span> out;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;}</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keyword">static</span> uint16_t crc16(uint8_t* data, uint16_t size)</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;{</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    uint16_t crc, i;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="keywordflow">for</span> (crc = 0; size &gt; 0; size--, data++)</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    {</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keywordflow">for</span> (i = 0x80; i; i &gt;&gt;= 1)</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        {</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            crc = crc_update(crc, *data &amp; i);</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        }</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    }</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; 16; i++)</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    {</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        crc = crc_update(crc, 0);</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    }</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="keywordflow">return</span> crc;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;}</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> xModemSend(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s, uint8_t* buf, <span class="keywordtype">size_t</span> len)</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;{</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordtype">int</span> ret;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    uint8_t eot = <a class="code" href="inertial_sense_boot_loader_8c.html#a6260fbddc4df59f2e92d06ef33120d9d">X_EOT</a>;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    uint8_t answer;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <a class="code" href="structxmodem__chunk__t.html">xmodem_chunk_t</a> chunk;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    chunk.<a class="code" href="structxmodem__chunk__t.html#a54cbea1a5a2bf6d38f3fdd4dc1210588">block</a> = 1;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    chunk.<a class="code" href="structxmodem__chunk__t.html#a7a2ab607af54ab9ea0dc8606350b916b">start</a> = <a class="code" href="inertial_sense_boot_loader_8c.html#a20f86ac37b1c9b112cbfd1bfc0598c71">X_SOH</a>;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="comment">// wait for receiver ping</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">do</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    {</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a41dbe152baba9cab417513fd8289a9a6">serialPortRead</a>(s, &amp;answer, <span class="keyword">sizeof</span>(uint8_t)) != <span class="keyword">sizeof</span>(uint8_t))</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        {</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        }</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    } <span class="keywordflow">while</span> (answer != <span class="charliteral">&#39;C&#39;</span>);</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="comment">// write up to one sector</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">while</span> (len)</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    {</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="keywordtype">size_t</span> z = 0;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="keywordtype">int</span> next = 0;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">//         char status;</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        z = <a class="code" href="_i_s_constants_8h.html#a89279935d2e2d0bcdc26cdf9e2ba5b1e">_MIN</a>(len, <span class="keyword">sizeof</span>(chunk.<a class="code" href="structxmodem__chunk__t.html#af7eb843c4fbc37134142cf71271f1e42">payload</a>));</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        memcpy(chunk.<a class="code" href="structxmodem__chunk__t.html#af7eb843c4fbc37134142cf71271f1e42">payload</a>, buf, z);</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        memset(chunk.<a class="code" href="structxmodem__chunk__t.html#af7eb843c4fbc37134142cf71271f1e42">payload</a> + z, 0xff, <span class="keyword">sizeof</span>(chunk.<a class="code" href="structxmodem__chunk__t.html#af7eb843c4fbc37134142cf71271f1e42">payload</a>) - z);</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        chunk.<a class="code" href="structxmodem__chunk__t.html#ac8e4ae3c656fb62e025100bcb3be1af7">crc</a> = <a class="code" href="_i_s_constants_8h.html#ae89189d0a7577e6b18155b6865077b85">SWAP16</a>(crc16(chunk.<a class="code" href="structxmodem__chunk__t.html#af7eb843c4fbc37134142cf71271f1e42">payload</a>, <span class="keyword">sizeof</span>(chunk.<a class="code" href="structxmodem__chunk__t.html#af7eb843c4fbc37134142cf71271f1e42">payload</a>)));</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        chunk.<a class="code" href="structxmodem__chunk__t.html#a08365679b65dbfa8c81f293fcd8f36bc">block_neg</a> = 0xff - chunk.<a class="code" href="structxmodem__chunk__t.html#a54cbea1a5a2bf6d38f3fdd4dc1210588">block</a>;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        ret = <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(s, (<span class="keyword">const</span> uint8_t*)&amp;chunk, <span class="keyword">sizeof</span>(<a class="code" href="structxmodem__chunk__t.html">xmodem_chunk_t</a>));</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="keywordflow">if</span> (ret != <span class="keyword">sizeof</span>(<a class="code" href="structxmodem__chunk__t.html">xmodem_chunk_t</a>))</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        {</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        }</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        ret = <a class="code" href="serial_port_8c.html#a7426c48831273ec45889f652623d00df">serialPortReadTimeout</a>(s, &amp;answer, <span class="keyword">sizeof</span>(uint8_t), <a class="code" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a>);</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keywordflow">if</span> (ret != <span class="keyword">sizeof</span>(uint8_t))</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        {</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        }</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="keywordflow">switch</span> (answer)</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        {</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="inertial_sense_boot_loader_8c.html#a4c1c7377d676d6e2f1b266f558e1c7f7">X_NAK</a>:</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment">//             status = &#39;N&#39;;</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="inertial_sense_boot_loader_8c.html#ace562d0cb6579fea3bd3fd1da60e0a4f">X_ACK</a>:</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">//             status = &#39;.&#39;;</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            next = 1;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="inertial_sense_boot_loader_8c.html#a1367e9ae908165cc92e4eeb9f164527b">X_CAN</a>:</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">//             status = &#39;?&#39;;</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        }</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="keywordflow">if</span> (next)</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        {</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;            chunk.block++;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;            len -= z;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            buf += z;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        }</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    }</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    ret = <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(s, &amp;eot, <span class="keyword">sizeof</span>(uint8_t));</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordflow">if</span> (ret != <span class="keyword">sizeof</span>(uint8_t))</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    }</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <a class="code" href="serial_port_8c.html#a714672a76f64069f76e025ec8d2fc66a">serialPortReadChar</a>(s, &amp;eot);</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;}</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8h.html#ab2b7c4df2c8e87dcbb5c9fe87dfd5192">  202</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="inertial_sense_boot_loader_8c.html#ab2b7c4df2c8e87dcbb5c9fe87dfd5192">bootloaderCycleBaudRate</a>(<span class="keywordtype">int</span> baudRate)</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;{</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_i_s_constants_8h.html#ae165d3d36e78851434995cd9e9fc8d78">_ARRAY_ELEMENT_COUNT</a>(s_baudRateList); i++)</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    {   <span class="comment">// Find current baudrate</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordflow">if</span> (baudRate == s_baudRateList[i])</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        {</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            <span class="comment">// Get next baudrate</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            <span class="keywordflow">if</span> (i + 1 &lt; <a class="code" href="_i_s_constants_8h.html#ae165d3d36e78851434995cd9e9fc8d78">_ARRAY_ELEMENT_COUNT</a>(s_baudRateList))</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            {</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                <span class="keywordflow">return</span> s_baudRateList[i + 1];</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;            }</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        }</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    }</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordflow">return</span> s_baudRateList[0];</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;}</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">// Finds the closest bootloader supported baudrate </span></div><div class="line"><a name="l00220"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8h.html#abc522a3dc48d8eec055d0ce46e86af48">  220</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="inertial_sense_boot_loader_8c.html#abc522a3dc48d8eec055d0ce46e86af48">bootloaderClosestBaudRate</a>(<span class="keywordtype">int</span> baudRate)</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;{</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_i_s_constants_8h.html#ae165d3d36e78851434995cd9e9fc8d78">_ARRAY_ELEMENT_COUNT</a>(s_baudRateList); i++)</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    {</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keywordflow">if</span> (baudRate &gt;= s_baudRateList[i])</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        {</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="keywordflow">return</span> s_baudRateList[i];</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        }</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    }</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="inertial_sense_boot_loader_8h.html#a3dd40c53dede7af6b3ef8ac95805fd41">IS_BAUD_RATE_BOOTLOADER_SLOW</a>;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;}</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">// negotiate the bootloader version, once a &#39;U&#39; character has been read, we read another character, timing out after 500 milliseconds</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">// if nothing comes back, we are using version 1, otherwise the version is the number sent back</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderNegotiateVersion(<a class="code" href="structbootloader__state__t.html">bootloader_state_t</a>* state)</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;{</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> v = 0;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">do</span> {</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a3cb89cb0314c641149ddefc46dd1f94d">serialPortReadCharTimeout</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, &amp;v, 500) == 0)</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        {</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            v = <span class="charliteral">&#39;1&#39;</span>;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        }</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    } <span class="keywordflow">while</span> (v == <span class="charliteral">&#39;U&#39;</span>);</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keywordflow">if</span> (v == <span class="charliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    {</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="comment">// version 1</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        state-&gt;<a class="code" href="structbootloader__state__t.html#abbaaea17b31dcecfd7f5e9b9548d1626">version</a> = 1;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        state-&gt;<a class="code" href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">firstPageSkipBytes</a> = 8192;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    }</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v &gt;= <span class="charliteral">&#39;2&#39;</span> &amp;&amp; v &lt;= <span class="charliteral">&#39;5&#39;</span>)</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    {</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="comment">// version 2, 3 (which sent v2), 4</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        state-&gt;<a class="code" href="structbootloader__state__t.html#abbaaea17b31dcecfd7f5e9b9548d1626">version</a> = v-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        state-&gt;<a class="code" href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">firstPageSkipBytes</a> = 16384;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    }</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    {</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Invalid version sent from bootloader: 0x%02X\n&quot;</span>, (<span class="keywordtype">int</span>)v);</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    }</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="preprocessor">#if PLATFORM_IS_WINDOWS</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="comment">// EvalTool and multiple bootloads under Windows 10 have issues with dropped data if verify runs too fast</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    state-&gt;<a class="code" href="structbootloader__state__t.html#a5349b92ca1d8e6d4c7849c81cfce6e44">verifyChunkSize</a> = 125;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    state-&gt;<a class="code" href="structbootloader__state__t.html#a5349b92ca1d8e6d4c7849c81cfce6e44">verifyChunkSize</a> = <a class="code" href="inertial_sense_boot_loader_8c.html#a4c548c41044465fad00d24c99eeced77">MAX_VERIFY_CHUNK_SIZE</a>;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;}</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> serialPortOpenInternal(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s, <span class="keywordtype">int</span> baudRate, <span class="keywordtype">char</span>* error, <span class="keywordtype">int</span> errorLength)</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;{</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="keywordflow">if</span> (error != 0 &amp;&amp; errorLength &gt; 0)</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    {</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        *error = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    }</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(s);</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    s-&gt;<a class="code" href="structserial__port__t.html#a8c767fdb868bc53e63afca6d0dbaae1d">error</a> = error;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    s-&gt;<a class="code" href="structserial__port__t.html#a2884da85ca80486926080009e7624315">errorLength</a> = errorLength;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a88df870918d4791ddaac45c562abf6cf">serialPortOpenRetry</a>(s, s-&gt;<a class="code" href="structserial__port__t.html#ae78066c31c9a5100228570d53e7fbec5">port</a>, baudRate == 0 ? <a class="code" href="inertial_sense_boot_loader_8h.html#a9be7e1b986a632f484f90d4a62b93489">IS_BAUD_RATE_BOOTLOADER</a> : baudRate, 1) == 0)</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    {</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Unable to open serial port at %s\n&quot;</span>, s-&gt;<a class="code" href="structserial__port__t.html#ae78066c31c9a5100228570d53e7fbec5">port</a>);</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    }</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;}</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">// calculate checksum - start is INCLUSIVE and end is EXCLUSIVE, if checkSumPosition is not 0, the checkSum is written to ptr + checkSumPosition</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderChecksum(<span class="keywordtype">int</span> checkSum, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* ptr, <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end, <span class="keywordtype">int</span> checkSumPosition, <span class="keywordtype">int</span> finalCheckSum)</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;{</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c1, c2;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* currentPtr = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)(ptr + start);</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* endPtr = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)(ptr + end - 1);</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> b;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="keywordflow">while</span> (currentPtr &lt; endPtr)</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    {</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        c1 = *(currentPtr++) | 0x20;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        c1 = (c1 &lt;= <span class="charliteral">&#39;9&#39;</span> ? c1 + 0xD0 : c1 + 0xA9);</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        c2 = *(currentPtr++) | 0x20;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        c2 = (c2 &lt;= <span class="charliteral">&#39;9&#39;</span> ? c2 + 0xD0 : c2 + 0xA9);</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        b = (c1 &lt;&lt; 4) | c2;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        checkSum += b;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    }</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="keywordflow">if</span> (finalCheckSum)</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    {</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        checkSum = (<span class="keywordtype">unsigned</span> char)(~checkSum + 1);</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    }</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="keywordflow">if</span> (checkSumPosition != 0)</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    {</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>((<span class="keywordtype">char</span>*)(ptr + checkSumPosition), 3, <span class="stringliteral">&quot;%.2X&quot;</span>, checkSum);</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    }</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="keywordflow">return</span> checkSum;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;}</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderEraseFlash(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s)</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;{</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="comment">// give the device this many seconds to erase flash before giving up</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> eraseFlashTimeoutMilliseconds = 60000;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> selectFlash[24];</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    memcpy(selectFlash, <span class="stringliteral">&quot;:03000006030000F4CC\0\0\0\0\0&quot;</span>, 24);</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    bootloaderChecksum(0, selectFlash, 1, 17, 17, 1);</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a315998701c41541c53f4041b4e3f8403">serialPortWriteAndWaitForTimeout</a>(s, selectFlash, 19, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;.\r\n&quot;</span>, 3, <a class="code" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a>) == 0)</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    {</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to select flash memory to erase\n&quot;</span>);</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    }</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    memcpy(selectFlash, <span class="stringliteral">&quot;:0200000400FFFBCC\0&quot;</span>, 18);</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    bootloaderChecksum(0, selectFlash, 1, 15, 15, 1);</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a315998701c41541c53f4041b4e3f8403">serialPortWriteAndWaitForTimeout</a>(s, selectFlash, 17, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;.\r\n&quot;</span>, 3, eraseFlashTimeoutMilliseconds) == 0)</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    {</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to perform erase flash memory operation\n&quot;</span>);</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    }</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;}</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderSelectPage(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s, <span class="keywordtype">int</span> page)</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;{</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="comment">// Atmel select page command (0x06) is 4 bytes and the data is always 0301xxxx where xxxx is a 16 bit page number in hex</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> changePage[24];</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>((<span class="keywordtype">char</span>*)changePage, 24, <span class="stringliteral">&quot;:040000060301%.4XCC&quot;</span>, page);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    bootloaderChecksum(0, changePage, 1, 17, 17, 1);</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a315998701c41541c53f4041b4e3f8403">serialPortWriteAndWaitForTimeout</a>(s, changePage, 19, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;.\r\n&quot;</span>, 3, <a class="code" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a>) == 0)</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    {</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to change to page %d\n&quot;</span>, page);</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    }</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;}</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderBeginProgramForCurrentPage(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s, <span class="keywordtype">int</span> startOffset, <span class="keywordtype">int</span> endOffset)</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;{</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="comment">// Atmel begin program command is 0x01, different from standard intel hex where command 0x01 is end of file</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="comment">// After the 0x01 is a 00 which means begin writing program</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="comment">// The begin program command uses the current page and specifies two 16 bit addresses that specify where in the current page</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="comment">//  the program code will be written</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> programPage[24];</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>((<span class="keywordtype">char</span>*)programPage, 24, <span class="stringliteral">&quot;:0500000100%.4X%.4XCC&quot;</span>, startOffset, endOffset);</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    bootloaderChecksum(0, programPage, 1, 19, 19, 1);</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a315998701c41541c53f4041b4e3f8403">serialPortWriteAndWaitForTimeout</a>(s, programPage, 21, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;.\r\n&quot;</span>, 3, <a class="code" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a>) == 0)</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    {</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to select offset %X to %X\n&quot;</span>, startOffset, endOffset);</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    }</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;}</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderReadLine(FILE* file, <span class="keywordtype">char</span> line[1024])</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;{</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <span class="keywordtype">char</span> c;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keywordtype">char</span>* currentPtr = line;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="keywordtype">char</span>* endPtr = currentPtr + 1023;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordflow">while</span> (currentPtr != endPtr)</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    {</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="comment">// read one char</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        c = (char)fgetc(file);</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;\r&#39;</span>)</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        {</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;            <span class="comment">// eat &#39;\r&#39; chars</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        }</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;\n&#39;</span> || c == (<span class="keywordtype">char</span>)EOF)</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        {</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            <span class="comment">// newline char, we have a line</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        }</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        *currentPtr++ = c;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    }</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    *currentPtr = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="comment">// TODO: Figure out why ARM64 bootloader hits this...</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">if</span> (currentPtr - line == 1023)</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    {</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    }</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(currentPtr - line);</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;}</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderUploadHexDataPage(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* hexData, <span class="keywordtype">int</span> byteCount, <span class="keywordtype">int</span>* currentOffset, <span class="keywordtype">int</span>* totalBytes, <span class="keywordtype">int</span>* verifyCheckSum)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;{</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="keywordtype">int</span> i;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="keywordflow">if</span> (byteCount == 0)</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    {</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    }</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="comment">// create a program request with just the hex characters that will fit on this page</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> programLine[12];</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>((<span class="keywordtype">char</span>*)programLine, 12, <span class="stringliteral">&quot;:%.2X%.4X00&quot;</span>, byteCount, *currentOffset);</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(s, programLine, 9) != 9)</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    {</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to write start page at offset %d\n&quot;</span>, *currentOffset);</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    }</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="comment">// add the previously written chars to the checksum</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="keywordtype">int</span> checkSum = bootloaderChecksum(0, programLine, 1, 9, 0, 0);</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="comment">// write all of the hex chars</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <span class="keywordtype">int</span> charsForThisPage = byteCount * 2;</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(s, hexData, charsForThisPage) != charsForThisPage)</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    {</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to write page data at offset %d\n&quot;</span>, *currentOffset);</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    }</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <span class="comment">// calculate verification checksum for this data</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; charsForThisPage; i++)</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    {</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        *verifyCheckSum = ((*verifyCheckSum &lt;&lt; 5) + *verifyCheckSum) + hexData[i];</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    }</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    checkSum = bootloaderChecksum(checkSum, hexData, 0, charsForThisPage, 0, 1);</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> checkSumHex[3];</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>((<span class="keywordtype">char</span>*)checkSumHex, 3, <span class="stringliteral">&quot;%.2X&quot;</span>, checkSum);</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a315998701c41541c53f4041b4e3f8403">serialPortWriteAndWaitForTimeout</a>(s, checkSumHex, 2, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;.\r\n&quot;</span>, 3, <a class="code" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a>) == 0)</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    {</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to write checksum %s at offset %d\n&quot;</span>, checkSumHex, *currentOffset);</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    }</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    *totalBytes += byteCount;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    *currentOffset += byteCount;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;}</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderUploadHexData(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* hexData, <span class="keywordtype">int</span> charCount, <span class="keywordtype">int</span>* currentOffset, <span class="keywordtype">int</span>* currentPage, <span class="keywordtype">int</span>* totalBytes, <span class="keywordtype">int</span>* verifyCheckSum)</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;{</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keywordflow">if</span> (charCount &gt; <a class="code" href="inertial_sense_boot_loader_8c.html#a5ec11ef11aace0f302a1ea711388a28b">MAX_SEND_COUNT</a>)</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    {</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Unexpected char count of %d for page %d at offset %X\n&quot;</span>, charCount, *currentPage, *currentOffset);</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    }</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (charCount == 0)</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    {</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    }</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="keywordtype">int</span> byteCount = charCount / 2;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <span class="comment">// check if we will overrun the current page</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <span class="keywordflow">if</span> (*currentOffset + byteCount &gt; <a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a>)</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    {</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="keywordtype">int</span> pageByteCount = <a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a> - *currentOffset;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="keywordflow">if</span> (bootloaderUploadHexDataPage(s, hexData, pageByteCount, currentOffset, totalBytes, verifyCheckSum) == 0)</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        {</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to upload %d bytes to page %d at offset %d\n&quot;</span>, pageByteCount, *currentPage, *currentOffset);</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        }</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        hexData += (pageByteCount * 2);</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        charCount -= (pageByteCount * 2);</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        <span class="comment">// change to the next page</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        *currentOffset = 0;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        (*currentPage)++;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        <span class="keywordflow">if</span> (!bootloaderSelectPage(s, *currentPage) || !bootloaderBeginProgramForCurrentPage(s, 0, <a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a> - 1))</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        {</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failure issuing select page command for upload\n&quot;</span>);</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        }</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    }</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keywordflow">if</span> (charCount != 0 &amp;&amp; bootloaderUploadHexDataPage(s, hexData, charCount / 2, currentOffset, totalBytes, verifyCheckSum) == 0)</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    {</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to upload %d bytes to page %d at offset %d\n&quot;</span>, charCount / 2, *currentPage, *currentOffset);</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    }</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;}</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderFillCurrentPage(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s, <span class="keywordtype">int</span>* currentPage, <span class="keywordtype">int</span>* currentOffset, <span class="keywordtype">int</span>* totalBytes, <span class="keywordtype">int</span>* verifyCheckSum)</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;{</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    <span class="keywordflow">if</span> (*currentOffset &lt; <a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a>)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    {</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hexData[256];</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        memset(hexData, <span class="charliteral">&#39;F&#39;</span>, 256);</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        <span class="keywordflow">while</span> (*currentOffset &lt; <a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a>)</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        {</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            <span class="keywordtype">int</span> byteCount = (<a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a> - *currentOffset) * 2;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;            <span class="keywordflow">if</span> (byteCount &gt; 256)</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;            {</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                byteCount = 256;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;            }</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;            memset(hexData, <span class="charliteral">&#39;F&#39;</span>, byteCount);</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;            <span class="keywordflow">if</span> (bootloaderUploadHexDataPage(s, hexData, byteCount / 2, currentOffset, totalBytes, verifyCheckSum) == 0)</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;            {</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to fill page %d with %d bytes at offset %d\n&quot;</span>, *currentPage, byteCount, *currentOffset);</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;            }</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        }</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    }</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;}</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderDownloadData(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s, <span class="keywordtype">int</span> startOffset, <span class="keywordtype">int</span> endOffset)</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;{</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="comment">// Atmel download data command is 0x03, different from standard intel hex where command 0x03 is start segment address</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> programLine[24];</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <span class="keywordtype">int</span> n;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    n = <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>((<span class="keywordtype">char</span>*)programLine, 24, <span class="stringliteral">&quot;:0500000300%.4X%.4XCC&quot;</span>, startOffset, endOffset);</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    programLine[n] = 0;</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    bootloaderChecksum(0, programLine, 1, 19, 19, 1);</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(s, programLine, 21) != 21)</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    {</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(s, <span class="stringliteral">&quot;Failed to attempt download offsets %X to %X\n&quot;</span>, startOffset, endOffset);</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    }</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;}</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderVerify(<span class="keywordtype">int</span> lastPage, <span class="keywordtype">int</span> checkSum, <a class="code" href="structbootloader__state__t.html">bootloader_state_t</a>* state)</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;{</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="keywordtype">int</span> verifyChunkSize = state-&gt;<a class="code" href="structbootloader__state__t.html#a5349b92ca1d8e6d4c7849c81cfce6e44">verifyChunkSize</a>;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keywordtype">int</span> chunkSize = <a class="code" href="inertial_sense_boot_loader_8c.html#a9f2d5fb9b4f02d9e5c7627bb1195c856">bootloader_min</a>(<a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a>, verifyChunkSize);</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <span class="keywordtype">int</span> realCheckSum = 5381;</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    <span class="keywordtype">int</span> totalCharCount = state-&gt;<a class="code" href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">firstPageSkipBytes</a> * 2;</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <span class="keywordtype">int</span> grandTotalCharCount = (lastPage + 1) * <a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a> * 2; <span class="comment">// char count</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <span class="keywordtype">int</span> i, pageOffset, readCount, actualPageOffset, pageChars, chunkIndex, lines;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="keywordtype">int</span> verifyByte = -1;</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> chunkBuffer[(<a class="code" href="inertial_sense_boot_loader_8c.html#a4c548c41044465fad00d24c99eeced77">MAX_VERIFY_CHUNK_SIZE</a> * 2) + 64]; <span class="comment">// extra space for overhead</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <span class="keywordtype">float</span> percent = 0.0f;</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c=0;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    FILE* verifyFile = 0;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a24f112ce5750a485a5679c51e45fa664">verifyFileName</a> != 0)</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    {</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        fopen_s(&amp;verifyFile, state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a24f112ce5750a485a5679c51e45fa664">verifyFileName</a>, <span class="stringliteral">&quot;wb&quot;</span>);</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        verifyFile = fopen(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a24f112ce5750a485a5679c51e45fa664">verifyFileName</a>, <span class="stringliteral">&quot;wb&quot;</span>);</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    }</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt;= lastPage; i++)</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    {</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="keywordflow">if</span> (bootloaderSelectPage(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, i) == 0)</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        {</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Failure issuing select page command for verify\n&quot;</span>);</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        }</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        pageOffset = (i == 0 ? state-&gt;<a class="code" href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">firstPageSkipBytes</a> : 0);</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        <span class="keywordflow">while</span> (pageOffset &lt; <a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a>)</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        {</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;            readCount = <a class="code" href="inertial_sense_boot_loader_8c.html#a9f2d5fb9b4f02d9e5c7627bb1195c856">bootloader_min</a>(chunkSize, <a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a> - pageOffset);</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;            <span class="comment">// range is inclusive on the uINS, so subtract one</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;            <span class="keywordflow">if</span> (bootloaderDownloadData(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, pageOffset, pageOffset + readCount - 1) == 0)</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;            {</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Failure issuing download data command\n&quot;</span>);</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            }</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;            <span class="comment">// each line has 7 overhead bytes, plus two bytes (hex) for each byte on the page and max 255 bytes per line</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            lines = (int)ceilf((<span class="keywordtype">float</span>)readCount / 255.0f);</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;            readCount = <a class="code" href="serial_port_8c.html#a7426c48831273ec45889f652623d00df">serialPortReadTimeout</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, chunkBuffer, (7 * lines) + (readCount * 2), <a class="code" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a>);</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;            chunkIndex = 0;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <span class="keywordflow">while</span> (chunkIndex &lt; readCount)</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            {</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                <span class="keywordflow">if</span> (chunkIndex &gt; readCount - 5)</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                {</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                    <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Unexpected start line during validation\n&quot;</span>);</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                }</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                <span class="comment">// skip the first 5 chars, they are simply ####=</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                <span class="keywordflow">if</span> (chunkBuffer[chunkIndex] == <span class="charliteral">&#39;X&#39;</span>)</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                {</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                    <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Invalid checksum during validation\n&quot;</span>);</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                }</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chunkBuffer[chunkIndex += 4] != <span class="charliteral">&#39;=&#39;</span>)</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                {</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                    <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Unexpected start line during validation\n&quot;</span>);</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                }</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                chunkBuffer[chunkIndex] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                actualPageOffset = strtol((<span class="keywordtype">char</span>*)(chunkBuffer + chunkIndex - 4), 0, 16);</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                <span class="keywordflow">if</span> (actualPageOffset != pageOffset)</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                {</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                    <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Unexpected offset during validation\n&quot;</span>);</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                }</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                pageChars = 0;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                chunkIndex++;</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                <span class="keywordflow">while</span> (chunkIndex &lt; readCount)</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                {</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                    c = chunkBuffer[chunkIndex++];</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                    <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;0&#39;</span> &amp;&amp; c &lt;= <span class="charliteral">&#39;9&#39;</span>) || (c &gt;= <span class="charliteral">&#39;A&#39;</span> &amp;&amp; c &lt;= <span class="charliteral">&#39;F&#39;</span>))</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                    {</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                        pageChars++;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                        totalCharCount++;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                        realCheckSum = ((realCheckSum &lt;&lt; 5) + realCheckSum) + c;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                        <span class="keywordflow">if</span> (verifyFile != 0)</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                        {</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                            <span class="keywordflow">if</span> (verifyByte == -1)</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                            {</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                                verifyByte = ((c &gt;= <span class="charliteral">&#39;0&#39;</span> &amp;&amp; c &lt;= <span class="charliteral">&#39;9&#39;</span>) ? c - <span class="charliteral">&#39;0&#39;</span> : c - <span class="charliteral">&#39;A&#39;</span> + 10) &lt;&lt; 4;</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                            }</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                            <span class="keywordflow">else</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                            {</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                                verifyByte |= (c &gt;= <span class="charliteral">&#39;0&#39;</span> &amp;&amp; c &lt;= <span class="charliteral">&#39;9&#39;</span>) ? c - <span class="charliteral">&#39;0&#39;</span> : c - <span class="charliteral">&#39;A&#39;</span> + 10;</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                                fputc(verifyByte, verifyFile);</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                                verifyByte = -1;</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                            }</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                        }</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                    }</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;\r&#39;</span>)</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                    {</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                    }</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;\n&#39;</span>)</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                    {</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                    }</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                    <span class="keywordflow">else</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;                    {</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;                        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Unexpected hex data during validation: 0x%02x [%c]\n&quot;</span>, c, c);</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                    }</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                }</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                <span class="keywordflow">if</span> (c != <span class="charliteral">&#39;\n&#39;</span>)</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                {</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                    <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Unexpected end line character found during validation: 0x%02x [%c]\n&quot;</span>, c, c);</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                }</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                <span class="comment">// increment page offset</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;                pageOffset += (pageChars / 2);</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a> != 0)</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                {</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                    percent = (float)totalCharCount / (<span class="keywordtype">float</span>)grandTotalCharCount;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                    <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, percent) == 0)</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                    {</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Validate firmware cancelled\n&quot;</span>);</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;                    }</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;                }</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;            }</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        }</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    }</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    <span class="keywordflow">if</span> (verifyFile != 0)</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    {</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        fclose(verifyFile);</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    }</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    <span class="keywordflow">if</span> (realCheckSum != checkSum)</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    {</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Download checksum 0x%08x != calculated checksum 0x%08x\n&quot;</span>, realCheckSum, checkSum);</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    }</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;}</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderProcessHexFile(FILE* file, <a class="code" href="structbootloader__state__t.html">bootloader_state_t</a>* state)</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;{</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="preprocessor">#define BUFFER_SIZE 1024</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <span class="keywordtype">int</span> currentPage = 0;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="keywordtype">int</span> currentOffset = state-&gt;<a class="code" href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">firstPageSkipBytes</a>;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keywordtype">int</span> lastSubOffset = currentOffset;</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    <span class="keywordtype">int</span> subOffset;</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    <span class="keywordtype">int</span> totalBytes = state-&gt;<a class="code" href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">firstPageSkipBytes</a>;</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    <span class="keywordtype">int</span> verifyCheckSum = 5381;</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordtype">int</span> lineLength;</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    <span class="keywordtype">float</span> percent = 0.0f;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <span class="keywordtype">char</span> line[<a class="code" href="inertial_sense_boot_loader_8c.html#a6b20d41d6252e9871430c242cb1a56e7">BUFFER_SIZE</a>];</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> output[<a class="code" href="inertial_sense_boot_loader_8c.html#a6b20d41d6252e9871430c242cb1a56e7">BUFFER_SIZE</a> * 2]; <span class="comment">// big enough to store an entire extra line of buffer if needed</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* outputPtr = output;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* outputPtrEnd = output + (<a class="code" href="inertial_sense_boot_loader_8c.html#a6b20d41d6252e9871430c242cb1a56e7">BUFFER_SIZE</a> * 2);</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keywordtype">int</span> outputSize;</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    <span class="keywordtype">int</span> page;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    <span class="keywordtype">int</span> pad;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    <span class="keywordtype">int</span> fileSize;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tmp[5];</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    <span class="keywordtype">int</span> i;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    fseek(file, 0, SEEK_END);</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    fileSize = ftell(file);</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    fseek(file, 0, SEEK_SET);</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    <span class="keywordflow">while</span> ((lineLength = bootloaderReadLine(file, line)) != 0)</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    {</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        <span class="keywordflow">if</span> (lineLength &gt; 12 &amp;&amp; line[7] == <span class="charliteral">&#39;0&#39;</span> &amp;&amp; line[8] == <span class="charliteral">&#39;0&#39;</span>)</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;        {</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;            <span class="keywordflow">if</span> (lineLength &gt; <a class="code" href="inertial_sense_boot_loader_8c.html#a6b20d41d6252e9871430c242cb1a56e7">BUFFER_SIZE</a> * 4)</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;            {</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Line length of %d was too large\n&quot;</span>, lineLength);</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;            }</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;            <span class="comment">// we need to know the offset that this line was supposed to be stored at so we can check if offsets are skipped</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;            memcpy(tmp, line + 3, 4);</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;            tmp[4] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;            subOffset = strtol((<span class="keywordtype">char</span>*)tmp, 0, 16);</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;            <span class="comment">// check if we skipped an offset, the intel hex file format can do this, in which case we need to make sure</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;            <span class="comment">// that the bytes that were skipped get set to something</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;            <span class="keywordflow">if</span> (subOffset &gt; lastSubOffset)</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;            {</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                <span class="comment">// pad with FF bytes, this is an internal implementation detail to how the device stores unused memory</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;                pad = (subOffset - lastSubOffset);</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;                <span class="keywordflow">if</span> (outputPtr + pad &gt;= outputPtrEnd)</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;                {</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                    <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;FF padding overflowed output buffer\n&quot;</span>);</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;                }</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;                <span class="keywordflow">while</span> (pad-- != 0)</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;                {</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;                    *outputPtr++ = <span class="charliteral">&#39;F&#39;</span>;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                    *outputPtr++ = <span class="charliteral">&#39;F&#39;</span>;</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                }</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;            }</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;            <span class="comment">// skip the first 9 chars which are not data, then take everything else minus the last two chars which are a checksum</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;            <span class="comment">// check for overflow</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;            pad = lineLength - 11;</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;            <span class="keywordflow">if</span> (outputPtr + pad &gt;= outputPtrEnd)</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;            {</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Line data overflowed output buffer\n&quot;</span>);</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;            }</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;            <span class="keywordflow">for</span> (i = 9; i &lt; lineLength - 2; i++)</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;            {</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                *outputPtr++ = line[i];</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;            }</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;            <span class="comment">// set the end offset so we can check later for skipped offsets</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;            lastSubOffset = subOffset + ((lineLength - 11) / 2);</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;            outputSize = (int)(outputPtr - output);</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;            <span class="comment">// we try to send the most allowed by this hex file format</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;            <span class="keywordflow">if</span> (outputSize &lt; <a class="code" href="inertial_sense_boot_loader_8c.html#a5ec11ef11aace0f302a1ea711388a28b">MAX_SEND_COUNT</a>)</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;            {</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                <span class="comment">// keep buffering</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;            }</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;            <span class="comment">// upload this chunk</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bootloaderUploadHexData(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, output, (outputSize &gt; <a class="code" href="inertial_sense_boot_loader_8c.html#a5ec11ef11aace0f302a1ea711388a28b">MAX_SEND_COUNT</a> ? <a class="code" href="inertial_sense_boot_loader_8c.html#a5ec11ef11aace0f302a1ea711388a28b">MAX_SEND_COUNT</a> : outputSize), &amp;currentOffset, &amp;currentPage, &amp;totalBytes, &amp;verifyCheckSum))</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;            {</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;            }</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;            outputSize -= <a class="code" href="inertial_sense_boot_loader_8c.html#a5ec11ef11aace0f302a1ea711388a28b">MAX_SEND_COUNT</a>;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            <span class="keywordflow">if</span> (outputSize &lt; 0 || outputSize &gt; <a class="code" href="inertial_sense_boot_loader_8c.html#a6b20d41d6252e9871430c242cb1a56e7">BUFFER_SIZE</a>)</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;            {</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Output size of %d was too large\n&quot;</span>, outputSize);</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            }</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (outputSize &gt; 0)</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;            {</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                <span class="comment">// move the left-over data to the beginning</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                memmove(output, output + <a class="code" href="inertial_sense_boot_loader_8c.html#a5ec11ef11aace0f302a1ea711388a28b">MAX_SEND_COUNT</a>, outputSize);</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;            }</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;            <span class="comment">// reset output ptr back to the next chunk of data</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;            outputPtr = output + outputSize;</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        }</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(line, <span class="stringliteral">&quot;:020000048&quot;</span>, 10) == 0 &amp;&amp; strlen(line) &gt;= 13)</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        {</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;            memcpy(tmp, line + 10, 3);</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;            tmp[3] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;            page = strtol((<span class="keywordtype">char</span>*)tmp, 0, 16);</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;            <span class="keywordflow">if</span> (page != 0)</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;            {</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                <span class="comment">// we found a change page command beyond the first, let&#39;s finish up this page and fill it to the max</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                lastSubOffset = 0;</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                outputSize = (int)(outputPtr - output);</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                <span class="keywordflow">if</span> (outputSize &lt; 0 || outputSize &gt; <a class="code" href="inertial_sense_boot_loader_8c.html#a6b20d41d6252e9871430c242cb1a56e7">BUFFER_SIZE</a>)</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                {</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;                    <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Output size of %d was too large\n&quot;</span>, outputSize);</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                }</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                <span class="comment">// flush the remainder of data to the page</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bootloaderUploadHexData(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, output, outputSize, &amp;currentOffset, &amp;currentPage, &amp;totalBytes, &amp;verifyCheckSum) == 0)</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                {</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                }</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                <span class="comment">// fill the remainder of the current page, the next time that bytes try to be written the page will be automatically incremented</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bootloaderFillCurrentPage(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, &amp;currentPage, &amp;currentOffset, &amp;totalBytes, &amp;verifyCheckSum) == 0)</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                {</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                }</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;                <span class="comment">// set the output ptr back to the beginning, no more data is in the queue</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;                outputPtr = output;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;            }</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        }</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;        <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a> != 0)</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        {</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;            percent = (float)ftell(file) / (float)fileSize; <span class="comment">// Dummy line to call ftell() once</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;            percent = (float)ftell(file) / (float)fileSize;</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;            <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, percent) == 0)</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;            {</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Upload firmware cancelled\n&quot;</span>);</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;            }</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        }</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    }</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    <span class="comment">// upload any left over data</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    outputSize = (int)(outputPtr - output);</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    <span class="keywordflow">if</span> (bootloaderUploadHexData(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, output, outputSize, &amp;currentOffset, &amp;currentPage, &amp;totalBytes, &amp;verifyCheckSum) == 0)</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    {</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    }</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="comment">// pad the remainder of the page with fill bytes</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="keywordflow">if</span> (currentOffset != 0 &amp;&amp; bootloaderFillCurrentPage(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, &amp;currentPage, &amp;currentOffset, &amp;totalBytes, &amp;verifyCheckSum) == 0)</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    {</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    }</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a> != 0 &amp;&amp; percent != 1.0f)</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    {</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, 1.0f);</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    }</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a63f210cda6f586f405e57570647007fb">flags</a>.<a class="code" href="structbootload__params__t.html#aef1cbbb5011e6b966f4b8333506091ee">bitFields</a>.enableVerify &amp;&amp; state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a> != 0)</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    {</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;            state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;Verifying flash...&quot;</span>);</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;        <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a> != 0 &amp;&amp; bootloaderVerify(currentPage, verifyCheckSum, state) == 0)</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;        {</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        }</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    }</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="comment">// send the &quot;reboot to program mode&quot; command and the device should start in program mode</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <span class="keywordflow">if</span>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;Rebooting unit...&quot;</span>);</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;:020000040300F7&quot;</span>, 15);</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(state-&gt;<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, 250);</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    <span class="keywordflow">return</span> 0;   <span class="comment">// Success</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;}</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderProcessBinFile(FILE* file, <a class="code" href="structbootload__params__t.html">bootload_params_t</a>* p)</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;{</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    <a class="code" href="structbootloader__state__t.html">bootloader_state_t</a> state;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    memset(&amp;state, 0, <span class="keyword">sizeof</span>(state));</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <span class="keywordtype">int</span> dataLength;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    <span class="keywordtype">int</span> verifyCheckSum;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    <span class="keywordtype">int</span> lastPage;</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="keywordtype">int</span> commandCount;</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="keywordtype">int</span> commandLength;</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[16];</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> commandType;</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="keywordtype">float</span> percent = 0.0f;</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    fseek(file, 0, SEEK_END);</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    <span class="keywordtype">int</span> fileSize = ftell(file);</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    fseek(file, 0, SEEK_SET);</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    <span class="comment">// verify checksum is first four bytes</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    verifyCheckSum = fgetc(file) | (fgetc(file) &lt;&lt; 8) | (fgetc(file) &lt;&lt; 16) | (fgetc(file) &lt;&lt; 24);</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <span class="comment">// last page is next two bytes</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    lastPage = fgetc(file) | (fgetc(file) &lt;&lt; 8);</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="comment">// the file is formatted like this:</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <span class="comment">// 4 bytes  : verify checksum</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="comment">// 2 bytes  : last page</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    <span class="comment">// LOOP:</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <span class="comment">// 1 byte - command type (0 = data, 1 = raw)</span></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <span class="comment">// 2 bytes - number of commands</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <span class="comment">// n commands...</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    <span class="comment">// Data command (0)</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="comment">//  2 bytes : Offset</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    <span class="comment">//  1 byte  : Data Length</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;    <span class="comment">//  n bytes : Data</span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    <span class="comment">//  1 byte  : Checksum</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    <span class="comment">// Raw command (1)</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    <span class="comment">//  1 byte  : Command length</span></div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    <span class="comment">//  n bytes : Command characters</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    <span class="comment">//  1 byte  : wait for character, &#39;\0&#39; for none</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="comment">//  1 byte  : sleep time after command is sent, in 250 millisecond intervals, 0 for no sleep</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="comment">//  1 byte  : wait for character timeout time in 250 millisecond intervals, 0 for no wait</span></div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    <span class="comment">// if not EOF, go to LOOP</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    <span class="keywordflow">while</span> (ftell(file) != fileSize)</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    {</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        commandType = (<span class="keywordtype">unsigned</span> char)fgetc(file);</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        commandCount = fgetc(file) | (fgetc(file) &lt;&lt; 8);</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        <span class="keywordflow">if</span> (commandType == 0)</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        {</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;            <span class="keywordflow">while</span> (commandCount-- &gt; 0)</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;            {</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;                <span class="comment">// write the :, data length, offset and 00 (data command)</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                commandLength = (fgetc(file) | (fgetc(file) &lt;&lt; 8));</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;                dataLength = fgetc(file); <span class="comment">// data length</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>((<span class="keywordtype">char</span>*)buf, 16, <span class="stringliteral">&quot;:%.2X%.4X00&quot;</span>, dataLength, commandLength);</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, buf, 9);</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;                <span class="comment">// write the data - we use the fact that the checksum byte is after the data bytes to loop it in with this loop</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                <span class="keywordflow">while</span> (dataLength-- &gt; -1)</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                {</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                    c = (<span class="keywordtype">unsigned</span> char)fgetc(file);</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;                    buf[0] = hexLookupTable[(c &gt;&gt; 4) &amp; 0x0F];</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                    buf[1] = hexLookupTable[(c &amp; 0x0F)];</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                    <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, buf, 2);</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                }</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                <a class="code" href="serial_port_8c.html#aaef9e6973f9dfd121a4eb87b7a13542e">serialPortWaitForTimeout</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;.\r\n&quot;</span>, 3, <a class="code" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a>);</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a> != 0)</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                {</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                    percent = (float)ftell(file) / (float)fileSize;</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                    p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, percent);</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                }</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;            }</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        }</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (commandType == 1)</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        {</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;            <span class="comment">// raw command, send it straight to the serial port as is</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;            <span class="keywordflow">while</span> (commandCount-- &gt; 0)</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;            {</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                commandLength = fgetc(file);</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                c = (<span class="keywordtype">unsigned</span> char)fgetc(file);</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                <span class="comment">// handshake char, ignore</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                <span class="keywordflow">if</span> (commandLength == 1 &amp;&amp; c == <span class="charliteral">&#39;U&#39;</span>)</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;                {</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                    <span class="comment">// read sleep interval and timeout interval, ignored</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                    c = (<span class="keywordtype">unsigned</span> char)fgetc(file);</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                    c = (<span class="keywordtype">unsigned</span> char)fgetc(file);</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                    <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                }</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                <span class="comment">// write command to serial port</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, &amp;c, 1);</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                <span class="keywordflow">while</span> (--commandLength &gt; 0)</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                {</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                    c = (<span class="keywordtype">unsigned</span> char)fgetc(file);</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                    <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, &amp;c, 1);</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                }</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                <span class="comment">// read sleep interval and sleep</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                c = (<span class="keywordtype">unsigned</span> char)fgetc(file);</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                commandLength = fgetc(file) * 250;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                <span class="keywordflow">if</span> (commandLength != 0)</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                {</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                    <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, commandLength);</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                }</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                <span class="comment">// read timeout interval</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                commandLength = fgetc(file) * 250;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                <span class="keywordflow">if</span> (commandLength != 0)</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                {</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> waitFor[4];</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                    <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>((<span class="keywordtype">char</span>*)waitFor, 4, <span class="stringliteral">&quot;%c\r\n&quot;</span>, c);</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                    <a class="code" href="serial_port_8c.html#aaef9e6973f9dfd121a4eb87b7a13542e">serialPortWaitForTimeout</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, waitFor, 3, commandLength);</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;                }</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;            }</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;            <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a> != 0)</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;            {</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                percent = (float)ftell(file) / (float)fileSize;</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, percent);</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            }</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;        }</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        {</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Invalid data in .bin file\n&quot;</span>);</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;        }</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    }</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a> != 0 &amp;&amp; percent != 1.0f)</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    {</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;        p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, 1.0f);</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    }</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    <span class="comment">// re-purpose this variable for the return code</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    dataLength = 1;</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    <span class="keywordflow">if</span> (state.<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#a63f210cda6f586f405e57570647007fb">flags</a>.<a class="code" href="structbootload__params__t.html#aef1cbbb5011e6b966f4b8333506091ee">bitFields</a>.enableVerify &amp;&amp; state.<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a> != 0)</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    {</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        dataLength = bootloaderVerify(lastPage, verifyCheckSum, &amp;state);</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    }</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <span class="keywordflow">if</span> (dataLength == 1)</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    {</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        <span class="comment">// send the &quot;reboot to program mode&quot; command and the device should start in program mode</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(state.<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;:020000040300F7&quot;</span>, 15);</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    }</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(state.<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a>-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, 250);</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    <span class="keywordflow">return</span> dataLength;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;}</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> bootloaderRestartAssist(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s)</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;{</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    <span class="comment">// USE WITH CAUTION! This will put in bootloader assist mode allowing a new bootloader to be put on, i.e. SAM-BA</span></div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    <span class="comment">// restart bootloader assist command</span></div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(s, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;:020000040700F3&quot;</span>, 15);</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    <span class="comment">// give the device time to start up</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(s, <a class="code" href="inertial_sense_boot_loader_8h.html#a36f9c553bf1daf7c7df99886e2f0eaa0">BOOTLOADER_REFRESH_DELAY</a>);</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;}</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> bootloaderRestart(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s)</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;{</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <span class="comment">// restart bootloader command</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(s, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;:020000040500F5&quot;</span>, 15);</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;    <span class="comment">// give the device time to start up</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;    <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(s, <a class="code" href="inertial_sense_boot_loader_8h.html#a36f9c553bf1daf7c7df99886e2f0eaa0">BOOTLOADER_REFRESH_DELAY</a>);</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;}</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderSync(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s)</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;{</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> handshaker[] = <span class="stringliteral">&quot;INERTIAL_SENSE_SYNC_DFU&quot;</span>;</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> handshakerChar = <span class="charliteral">&#39;U&#39;</span>;</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <span class="comment">//Most usages of this function we do not know if we can communicate (still doing auto-baud or checking to see if the bootloader or application is running) so trying to reset unit here does not make sense.</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    <span class="comment">//This was probably added because the PC bootloader was doing multiple syncs in a row but the hardware bootloader only allowed one.</span></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    <span class="comment">//Will leave it just in case</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="comment">// reboot the device in case it is stuck</span></div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    bootloaderRestart(s);</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    <span class="comment">// write a &#39;U&#39; to handshake with the boot loader - once we get a &#39;U&#39; back we are ready to go</span></div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="inertial_sense_boot_loader_8h.html#a94bf881abdc00f884f3580b5b7823ede">BOOTLOADER_RETRIES</a>; i++)</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    {</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a315998701c41541c53f4041b4e3f8403">serialPortWriteAndWaitForTimeout</a>(s, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;handshaker, (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(handshaker), &amp;handshakerChar, 1, <a class="code" href="inertial_sense_boot_loader_8h.html#ae9af5fb05b7c83d516ab4683ca1faf86">BOOTLOADER_RESPONSE_DELAY</a>))</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        {   <span class="comment">// Success</span></div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;            <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(s, <a class="code" href="inertial_sense_boot_loader_8h.html#a36f9c553bf1daf7c7df99886e2f0eaa0">BOOTLOADER_REFRESH_DELAY</a>);</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;            <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        }</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    }</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;}</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloaderHandshake(<a class="code" href="structbootload__params__t.html">bootload_params_t</a>* p)</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;{</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    <span class="comment">//Port should already be closed, but make sure</span></div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    <span class="comment">// Ensure we use closest baudrate supported by bootloader</span></div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;    p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a> = <a class="code" href="inertial_sense_boot_loader_8c.html#abc522a3dc48d8eec055d0ce46e86af48">bootloaderClosestBaudRate</a>(p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a>);</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;<span class="preprocessor">#if ENABLE_BOOTLOADER_BAUD_DETECTION</span></div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    <span class="comment">// ensure that we start off with a valid baud rate</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a> == 0)</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    {</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a> = <a class="code" href="inertial_sense_boot_loader_8c.html#ab2b7c4df2c8e87dcbb5c9fe87dfd5192">bootloaderCycleBaudRate</a>(p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a>);</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;    }</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="comment">// try handshaking at each baud rate</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="_i_s_constants_8h.html#ae165d3d36e78851434995cd9e9fc8d78">_ARRAY_ELEMENT_COUNT</a>(s_baudRateList) + 1; i++)</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;#endif <span class="comment">// ENABLE_BOOTLOADER_BAUD_DETECTION</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    {</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        <span class="keywordflow">if</span> (serialPortOpenInternal(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a>, p-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>) == 0)</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;        {</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;            <span class="comment">// can&#39;t open the port, fail</span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        }</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bootloaderSync(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>))</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        {</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;            <span class="comment">// success, reset baud rate for next round of handshaking</span></div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;            p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a> = 0;</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;            <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        }</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="preprocessor">#if ENABLE_BOOTLOADER_BAUD_DETECTION</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;        <span class="comment">// retry at a different baud rate</span></div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;        p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a> = <a class="code" href="inertial_sense_boot_loader_8c.html#ab2b7c4df2c8e87dcbb5c9fe87dfd5192">bootloaderCycleBaudRate</a>(p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a>);</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;<span class="preprocessor">#endif // ENABLE_BOOTLOADER_BAUD_DETECTION</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    }</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    <span class="comment">// failed to handshake, fatal error</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, <span class="stringliteral">&quot;Unable to handshake with bootloader\n&quot;</span>);</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;}</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> bootloadGetVersion(<a class="code" href="structserial__port__t.html">serial_port_t</a>* s, <span class="keywordtype">int</span>* major, <span class="keywordtype">char</span>* minor, <span class="keywordtype">int</span>* sambaAvaliable)</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;{</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    <span class="comment">//purge buffer</span></div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;<span class="preprocessor">#define BUF_SIZE    100</span></div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[<a class="code" href="inertial_sense_boot_loader_8c.html#a6821bafc3c88dfb2e433a095df9940c6">BUF_SIZE</a>];</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;    <span class="keywordflow">while</span> (<a class="code" href="serial_port_8c.html#a41dbe152baba9cab417513fd8289a9a6">serialPortRead</a>(s, buf, <a class="code" href="inertial_sense_boot_loader_8c.html#a6821bafc3c88dfb2e433a095df9940c6">BUF_SIZE</a>)){}</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;    <span class="comment">//Send command</span></div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;    <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(s, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;:020000041000EA&quot;</span>, 15);</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    <span class="comment">//Read Version, SAM-BA Available, and ok (.\r\n) response</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;    <span class="keywordtype">int</span> count = <a class="code" href="serial_port_8c.html#a7426c48831273ec45889f652623d00df">serialPortReadTimeout</a>(s, buf, 8, 1000);</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    <span class="keywordflow">if</span> (count != 8 || buf[0] != 0xAA || buf[1] != 0x55 || buf[5] != <span class="charliteral">&#39;.&#39;</span> || buf[6] != <span class="charliteral">&#39;\r&#39;</span> || buf[7] != <span class="charliteral">&#39;\n&#39;</span>)</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    {</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;        *major = 0;</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;        *minor = 0;</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;        *sambaAvaliable = 1;</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    }</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    *major = buf[2];</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    *minor = buf[3];</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    *sambaAvaliable = buf[4] == 0x1;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;}</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloadFileInternal(FILE* file, <a class="code" href="structbootload__params__t.html">bootload_params_t</a>* p)</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;{</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;Starting bootloader...&quot;</span>);</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="inertial_sense_boot_loader_8c.html#a98c0ef9d938083384803b4d7d90d3373">enableBootloader</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, p-&gt;<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a>, p-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>, p-&gt;<a class="code" href="structbootload__params__t.html#a0d32da48ece6e00d21a5b7be5c84a31d">bootloadEnableCmd</a>))</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    {</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        <span class="comment">//If we have an error, exit</span></div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>[0] != 0)</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;            p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;Unable to find bootloader.&quot;</span>);</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a> != 0)</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;        {</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;            <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;Attempting to reload bootloader...&quot;</span>);</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;            <span class="comment">//Send file</span></div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;            <a class="code" href="structbootload__params__t.html">bootload_params_t</a> params;</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;            memset(&amp;params, 0, <span class="keyword">sizeof</span>(params));</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;            params.<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a> = p-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a>;</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;            params.<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a> = p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>;</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;            memset(params.<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>));</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;            params.<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a> = p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>;</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;            params.<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a> = p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a>;</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;            params.<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a> = p-&gt;<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a>;</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;            params.<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a> = p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>;</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;            params.<a class="code" href="structbootload__params__t.html#a9503237f9c9e527a60158ee62822ab76">numberOfDevices</a> = 1;</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;            params.<a class="code" href="structbootload__params__t.html#a63f210cda6f586f405e57570647007fb">flags</a>.<a class="code" href="structbootload__params__t.html#aef1cbbb5011e6b966f4b8333506091ee">bitFields</a>.enableVerify = 1;</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;            <span class="keywordflow">if</span> (!bootloadUpdateBootloaderSendFile(&amp;params))</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;                <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;            <a class="code" href="_i_s_utilities_8h.html#a038783cd27cbb54e9c8d8708f147168e">SLEEP_MS</a>(1000);</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;            <span class="comment">//Bootloader updated successfully.  Return 1 to indicate firmware update is now needed.</span></div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;            <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;        }</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    }</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <span class="comment">// Sync with bootloader</span></div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    <span class="keywordflow">if</span> (!bootloaderHandshake(p))</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    {</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    }</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    <span class="keywordtype">int</span> fileNameLength = (int)strnlen(p-&gt;<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a>, 255);</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <span class="keywordflow">if</span> (fileNameLength &gt; 4 &amp;&amp; strncmp(p-&gt;<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a> + fileNameLength - 4, <span class="stringliteral">&quot;.bin&quot;</span>, 4) == 0)</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    {</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;        <span class="comment">//At this time, binary files are not supported for updating firmware</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>(p-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>, <span class="stringliteral">&quot;Binary firmware files are not supported.&quot;</span>);</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    }</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    {</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;        <a class="code" href="structbootloader__state__t.html">bootloader_state_t</a> state;</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;        memset(&amp;state, 0, <span class="keyword">sizeof</span>(state));</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;        state.<a class="code" href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">param</a> = p;</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;        <span class="keywordflow">if</span>(!bootloaderNegotiateVersion(&amp;state)) <span class="comment">// negotiate version</span></div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;        {</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;        }</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        <span class="keywordtype">int</span> blVerMajor, sambaSupport;</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;        <span class="keywordtype">char</span> blVerMinor;</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;        bootloadGetVersion(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, &amp;blVerMajor, &amp;blVerMinor, &amp;sambaSupport);</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;        <span class="keywordflow">if</span> (blVerMajor &gt; 0 &amp;&amp; p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;        {</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;            <span class="keywordtype">char</span> str[100];</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>(str, 100, <span class="stringliteral">&quot;Bootloader version %d%c found. SAM-BA is %s on port.&quot;</span>, blVerMajor, blVerMinor, sambaSupport == 1 ? <span class="stringliteral">&quot;supported&quot;</span> : <span class="stringliteral">&quot;NOT supported&quot;</span>);</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;                p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, str);</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        }</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a>[0] != 0)</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;        {</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;            <span class="keywordtype">int</span> fileVerMajor = 0;</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;            <span class="keywordtype">char</span> fileVerMinor = 0;</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;            <span class="comment">//Retrieve version from file</span></div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;            <span class="comment">//Only check if we find valid version info in file</span></div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="inertial_sense_boot_loader_8c.html#af29610e6a77c6fc7976737ab667cbca2">bootloadGetBootloaderVersionFromFile</a>(p-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a>, &amp;fileVerMajor, &amp;fileVerMinor) || p-&gt;<a class="code" href="structbootload__params__t.html#a6cdc14dfbcd28d03c3c68bf965f43720">forceBootloaderUpdate</a> &gt; 0)</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;            {</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                <span class="comment">//printf(&quot;Bootloader file version: %d%c.\n&quot;, fileVerMajor, fileVerMinor);</span></div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;                <span class="comment">//Check bootloader version against file</span></div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;                <span class="keywordflow">if</span> (blVerMajor &lt; fileVerMajor || </div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;                    (blVerMajor == fileVerMajor &amp;&amp; blVerMinor &lt; fileVerMinor) || </div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;                    p-&gt;<a class="code" href="structbootload__params__t.html#a6cdc14dfbcd28d03c3c68bf965f43720">forceBootloaderUpdate</a> &gt; 0)</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;                {</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;                    <span class="keywordflow">if</span> (sambaSupport)</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;                    {</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;                        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;                        {</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;                            <span class="keywordtype">char</span> str[100];</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;                            <span class="keywordflow">if</span>(blVerMajor &gt; 0)</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;                                <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>(str, 100, <span class="stringliteral">&quot;Updating bootloader to version %d%c...&quot;</span>, fileVerMajor, fileVerMinor);</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;                            <span class="keywordflow">else</span></div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;                                <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>(str, 100, <span class="stringliteral">&quot;Updating bootloader...&quot;</span>);</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;                            p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, str);</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;                        }</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;                        <span class="comment">//Start SAM-BA</span></div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;                        bootloaderRestartAssist(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;                        <span class="comment">//Send file</span></div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;                        <a class="code" href="structbootload__params__t.html">bootload_params_t</a> params;</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                        memset(&amp;params, 0, <span class="keyword">sizeof</span>(params));</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;                        params.<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a> = p-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a>;</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;                        params.<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a> = p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>;</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;                        memset(params.<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>));</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;                        params.<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a> = p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>;</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;                        params.<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a> = p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a>;</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;                        params.<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a> = p-&gt;<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a>;</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;                        params.<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a> = p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>;</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                        params.<a class="code" href="structbootload__params__t.html#a9503237f9c9e527a60158ee62822ab76">numberOfDevices</a> = 1;</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;                        params.<a class="code" href="structbootload__params__t.html#a63f210cda6f586f405e57570647007fb">flags</a>.<a class="code" href="structbootload__params__t.html#aef1cbbb5011e6b966f4b8333506091ee">bitFields</a>.enableVerify = 1;</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                        <span class="keywordflow">if</span> (!bootloadUpdateBootloaderSendFile(&amp;params))</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;                            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;                        <a class="code" href="_i_s_utilities_8h.html#a038783cd27cbb54e9c8d8708f147168e">SLEEP_MS</a>(1000);</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                        <span class="comment">//Bootloader updated successfully.  Return 1 to indicate firmware update is now needed.</span></div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                        <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                    }</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                    <span class="keywordflow">else</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                    {   <span class="comment">//Bootloader is out of date but SAM-BA is not supported on port</span></div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;                        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                            p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;WARNING!  Bootloader is out of date. Port used to communicate with bootloader does not support updating the bootloader. To force firmware update, run update without including the bootloader file.&quot;</span>);</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;                        <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>(p-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>, <span class="stringliteral">&quot;Bootloader is out of date but current port does not support updating bootloader. To force update, run firmware update without including the bootloader file.\n&quot;</span>);</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;                        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;                    }</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;                }</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;            }            </div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;        }</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160; </div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;            p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;Erasing flash...&quot;</span>);</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <span class="keywordflow">if</span> ( !bootloaderEraseFlash(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>) <span class="comment">/*erase all flash */</span> || !bootloaderSelectPage(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, 0) <span class="comment">/*select the first page*/</span>)</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;            p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;Programming flash...&quot;</span>);</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;        <span class="comment">// begin programming the first page</span></div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        <span class="keywordflow">if</span>(!bootloaderBeginProgramForCurrentPage(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, state.<a class="code" href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">firstPageSkipBytes</a>, <a class="code" href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a> - 1))</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;        <span class="keywordflow">return</span> bootloaderProcessHexFile(file, &amp;state);</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    }</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;}</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> samBaWriteWord(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port, uint32_t address, uint32_t value)</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;{</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[32];</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;    <span class="keywordtype">int</span> count = <a class="code" href="_i_s_constants_8h.html#a770571e12ff9370899184528f4b4626d">SNPRINTF</a>((<span class="keywordtype">char</span>*)buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;W%08x,%08x#&quot;</span>, address, value);</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(port, buf, count) == count);</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;}</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;<span class="keyword">static</span> uint32_t samBaReadWord(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port, uint32_t address)</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;{</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[16];</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="keywordtype">int</span> count = <a class="code" href="_i_s_constants_8h.html#a770571e12ff9370899184528f4b4626d">SNPRINTF</a>((<span class="keywordtype">char</span>*)buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;w%08x,#&quot;</span>, address);</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(port, buf, count) == count &amp;&amp;</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;        (<a class="code" href="serial_port_8c.html#a7426c48831273ec45889f652623d00df">serialPortReadTimeout</a>(port, buf, <span class="keyword">sizeof</span>(uint32_t), <a class="code" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a>)) == <span class="keyword">sizeof</span>(uint32_t))</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    {</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;        uint32_t val = (buf[3] &lt;&lt; 24) | (buf[2] &lt;&lt; 16) | (buf[1] &lt;&lt; 8) | buf[0];</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;        <span class="keywordflow">return</span> val;</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    }</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;}</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;<span class="keyword">static</span> uint32_t samBaFlashWaitForReady(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port)</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;{</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    uint32_t status = 0;</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 10; i++)</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;    {</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;        status = samBaReadWord(port, 0x400e0c08);</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;        <span class="keywordflow">if</span> (status &amp; 1)</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;        {</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        }</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;        <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(port, 20);</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    }</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    <span class="keywordflow">return</span> status;</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;}</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> samBaSetBootFromFlash(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port)</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;{</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;    <span class="comment">// EEFC_FCR, EEFC_FCR_FKEY_PASSWD | EEFC_FCR_FARG_BOOT | EEFC_FCR_FCMD_SGPB</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    <span class="keywordflow">if</span> (samBaWriteWord(port, 0x400e0c04, 0x5a000000 | 0x00000100 | 0x0000000b))</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;    {</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;        <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)samBaFlashWaitForReady(port);</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    }</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;}</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> samBaFlashEraseWritePage(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port, <span class="keywordtype">size_t</span> offset,</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;                                    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[<a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>], <span class="keywordtype">int</span> isUSB)</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;{</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    uint16_t page = (uint16_t)(offset / <a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>);</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> _buf[32];</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    <span class="keywordtype">int</span> count;</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    <span class="comment">// start lots of data</span></div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;    <span class="keywordflow">if</span> (isUSB)</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    {</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;        count = <a class="code" href="_i_s_constants_8h.html#a770571e12ff9370899184528f4b4626d">SNPRINTF</a>((<span class="keywordtype">char</span>*)_buf, <span class="keyword">sizeof</span>(_buf), <span class="stringliteral">&quot;S%08x,%08x#&quot;</span>,</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;                         (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(<a class="code" href="inertial_sense_boot_loader_8c.html#a9bab5e89643dedb225c44447a84b4eab">SAM_BA_FLASH_START_ADDRESS</a> + offset),</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                         (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>);</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;        <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(port, _buf, count);</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;        <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(port, buf, <a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>);</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    }</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    {</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;        count = <a class="code" href="_i_s_constants_8h.html#a770571e12ff9370899184528f4b4626d">SNPRINTF</a>((<span class="keywordtype">char</span>*)_buf, <span class="keyword">sizeof</span>(_buf), <span class="stringliteral">&quot;S%08x,#&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(<a class="code" href="inertial_sense_boot_loader_8c.html#a9bab5e89643dedb225c44447a84b4eab">SAM_BA_FLASH_START_ADDRESS</a> + offset));</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;        <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(port, _buf, count);</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;        <span class="comment">// send page data</span></div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;        <span class="keywordflow">if</span> (xModemSend(port, buf, <a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>))</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;        {</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;        }</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    }</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    <span class="comment">// EEFC FCR: finish write page</span></div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    count = <a class="code" href="_i_s_constants_8h.html#a770571e12ff9370899184528f4b4626d">SNPRINTF</a>((<span class="keywordtype">char</span>*)_buf, <span class="keyword">sizeof</span>(_buf), <span class="stringliteral">&quot;W%08x,5a%04x03#&quot;</span>, 0x400e0c04, page);</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(port, _buf, count);</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    <span class="keywordflow">return</span> samBaFlashWaitForReady(port);</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;}</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> samBaVerify(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port, uint32_t checksum, <span class="keyword">const</span> <span class="keywordtype">void</span>* obj, <a class="code" href="inertial_sense_boot_loader_8h.html#af3960f600015ba067228d38c25f178f0">pfnBootloadProgress</a> verifyProgress)</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;{</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    uint32_t checksum2 = 0;</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    uint32_t nextAddress;</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[512];</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="keywordtype">int</span> count;</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    <span class="keywordflow">for</span> (uint32_t address = <a class="code" href="inertial_sense_boot_loader_8c.html#a9bab5e89643dedb225c44447a84b4eab">SAM_BA_FLASH_START_ADDRESS</a>; address &lt; (<a class="code" href="inertial_sense_boot_loader_8c.html#a9bab5e89643dedb225c44447a84b4eab">SAM_BA_FLASH_START_ADDRESS</a> + <a class="code" href="inertial_sense_boot_loader_8c.html#abac28520efbc61d0cb08abc48263753c">SAM_BA_BOOTLOADER_SIZE</a>); )</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    {</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;        nextAddress = address + <a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>;</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;        <span class="keywordflow">while</span> (address &lt; nextAddress)</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        {</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;            count = <a class="code" href="_i_s_constants_8h.html#a770571e12ff9370899184528f4b4626d">SNPRINTF</a>((<span class="keywordtype">char</span>*)buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;w%08x,#&quot;</span>, address);</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;            <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(port, buf, count);</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;            address += <span class="keyword">sizeof</span>(uint32_t);</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;            <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(port, 2); <span class="comment">// give device time to process command</span></div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;        }</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;        count = <a class="code" href="serial_port_8c.html#a7426c48831273ec45889f652623d00df">serialPortReadTimeout</a>(port, buf, <a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>, <a class="code" href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a>);</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;        <span class="keywordflow">if</span> (count == <a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>)</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;        {</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;            <span class="keywordflow">for</span> (uint32_t* ptr = (uint32_t*)buf, *ptrEnd = (uint32_t*)(buf + <span class="keyword">sizeof</span>(buf)); ptr &lt; ptrEnd; ptr++)</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;            {</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;                checksum2 ^= *ptr;</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;            }</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;        }</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;        {</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;        }</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        <span class="keywordflow">if</span> (verifyProgress != 0)</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        {</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;            verifyProgress(obj, (<span class="keywordtype">float</span>)(address - <a class="code" href="inertial_sense_boot_loader_8c.html#a9bab5e89643dedb225c44447a84b4eab">SAM_BA_FLASH_START_ADDRESS</a>) / (<span class="keywordtype">float</span>)<a class="code" href="inertial_sense_boot_loader_8c.html#abac28520efbc61d0cb08abc48263753c">SAM_BA_BOOTLOADER_SIZE</a>);</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;        }</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    }</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    <span class="keywordflow">if</span> (checksum != checksum2)</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;    {</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;        <span class="keywordflow">return</span> -2;</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    }</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;}</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> samBaSoftReset(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port)</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;{</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    <span class="comment">// RSTC_CR, RSTC_CR_KEY_PASSWD | RSTC_CR_PROCRST</span></div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    uint32_t status;</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    <span class="keywordflow">if</span> (!samBaWriteWord(port, 0x400e1800, 0xa5000000 | 0x00000001))</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    {</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;    }</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 100; i++)</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;    {</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;        status = samBaReadWord(port, 0x400e1804); <span class="comment">// RSTC_SR</span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;        <span class="keywordflow">if</span> (!(status &amp; 0x00020000)) <span class="comment">// RSTC_SR_SRCMP</span></div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;        {</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;            <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;        }</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;        <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(port, 20);</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    }</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;}</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;</div><div class="line"><a name="l01479"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8h.html#ac8d2f33ea59110e28863a4c5516148e8"> 1479</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="inertial_sense_boot_loader_8c.html#ac8d2f33ea59110e28863a4c5516148e8">bootloadFile</a>(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port, <span class="keyword">const</span> <span class="keywordtype">char</span>* fileName, <span class="keyword">const</span> <span class="keywordtype">char</span> * bootName,</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">void</span>* obj, <a class="code" href="inertial_sense_boot_loader_8h.html#af3960f600015ba067228d38c25f178f0">pfnBootloadProgress</a> uploadProgress, <a class="code" href="inertial_sense_boot_loader_8h.html#af3960f600015ba067228d38c25f178f0">pfnBootloadProgress</a> verifyProgress)</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;{</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;    <a class="code" href="structbootload__params__t.html">bootload_params_t</a> params;</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    memset(&amp;params, 0, <span class="keyword">sizeof</span>(params));</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;    params.<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a> = fileName;</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;    params.<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a> = bootName;</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    params.<a class="code" href="structbootload__params__t.html#a6cdc14dfbcd28d03c3c68bf965f43720">forceBootloaderUpdate</a> = 0;</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;    params.<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a> = port;</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;    memset(params.<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>));</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;    params.<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a> = obj;</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;    params.<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a> = uploadProgress;</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;    params.<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a> = verifyProgress;</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;    params.<a class="code" href="structbootload__params__t.html#a9503237f9c9e527a60158ee62822ab76">numberOfDevices</a> = 1;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;    params.<a class="code" href="structbootload__params__t.html#a63f210cda6f586f405e57570647007fb">flags</a>.<a class="code" href="structbootload__params__t.html#aef1cbbb5011e6b966f4b8333506091ee">bitFields</a>.enableVerify = (verifyProgress != 0);</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="inertial_sense_boot_loader_8c.html#a0fb19b81296391f0e36ba02b0a85d485">bootloadFileEx</a>(&amp;params);</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;}</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;</div><div class="line"><a name="l01498"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8h.html#a0fb19b81296391f0e36ba02b0a85d485"> 1498</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="inertial_sense_boot_loader_8c.html#a0fb19b81296391f0e36ba02b0a85d485">bootloadFileEx</a>(<a class="code" href="structbootload__params__t.html">bootload_params_t</a>* params)</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;{</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;    <span class="keywordflow">if</span> (strstr(params-&gt;<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a>, <span class="stringliteral">&quot;EVB&quot;</span>) != NULL)</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;    {   <span class="comment">// Enable EVB bootloader</span></div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;        strncpy(params-&gt;<a class="code" href="structbootload__params__t.html#a0d32da48ece6e00d21a5b7be5c84a31d">bootloadEnableCmd</a>, <span class="stringliteral">&quot;EBLE&quot;</span>, 4);</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;    }</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;    {   <span class="comment">// Enable uINS bootloader</span></div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;        strncpy(params-&gt;<a class="code" href="structbootload__params__t.html#a0d32da48ece6e00d21a5b7be5c84a31d">bootloadEnableCmd</a>, <span class="stringliteral">&quot;BLEN&quot;</span>, 4);</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;    }</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;    <span class="keywordtype">int</span> result = -1;    <span class="comment">// 0 = success</span></div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    <span class="keywordflow">if</span> (params-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a> != 0 &amp;&amp; <a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a> &gt; 0)</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    {</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;        *params-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a> = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;    }   </div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;    <span class="comment">// open the file</span></div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;    FILE* file = 0;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;    fopen_s(&amp;file, params-&gt;<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a>, <span class="stringliteral">&quot;rb&quot;</span>);</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    file = fopen(params-&gt;<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a>, <span class="stringliteral">&quot;rb&quot;</span>);</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;    <span class="keywordflow">if</span> (file == 0)</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;    {</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;        <span class="keywordflow">if</span> (params-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a> != 0)</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        {</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>(params-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>, <span class="stringliteral">&quot;Unable to open file: %s&quot;</span>, params-&gt;<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a>);</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;        }</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        <span class="keywordflow">return</span> result;</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;    }</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;    <span class="comment">// If bootloader file was specified, check it is openable</span></div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;    <span class="keywordflow">if</span> (params-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a> &amp;&amp; params-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a>[0] != 0)</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;    {</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;        FILE* blfile = 0;</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;        fopen_s(&amp;blfile, params-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a>, <span class="stringliteral">&quot;rb&quot;</span>);</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;        blfile = fopen(params-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a>, <span class="stringliteral">&quot;rb&quot;</span>);</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        <span class="keywordflow">if</span> (blfile == 0)</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;        {</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>(params-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>, <span class="stringliteral">&quot;Unable to open bootloader file: %s&quot;</span>, params-&gt;<a class="code" href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootName</a>);</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;            <span class="keywordflow">return</span> result;</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;        }</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;        fclose(blfile);</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    }</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;    result = bootloadFileInternal(file, params);</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;    <span class="keywordflow">if</span> (result == 1)</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    {    <span class="comment">// Bootloader was just updated.  Start firmware update. </span></div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;        params-&gt;<a class="code" href="structbootload__params__t.html#a6cdc14dfbcd28d03c3c68bf965f43720">forceBootloaderUpdate</a> = 0;</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;        result = bootloadFileInternal(file, params);</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;    }</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;    <span class="keywordflow">if</span> (result == -1)</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;    {</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a>(params-&gt;<a class="code" href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">error</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a>, <span class="stringliteral">&quot;Update failed&quot;</span>);</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        <span class="comment">// reboot the device back into boot-loader mode</span></div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;        <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(params-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;:020000040500F5&quot;</span>, 15);</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;        <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(params-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, 500);</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    }</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;    fclose(file);</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;    <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(params-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    <span class="keywordflow">return</span> result;</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;}</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;</div><div class="line"><a name="l01584"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8h.html#af29610e6a77c6fc7976737ab667cbca2"> 1584</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="inertial_sense_boot_loader_8c.html#af29610e6a77c6fc7976737ab667cbca2">bootloadGetBootloaderVersionFromFile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* bootName, <span class="keywordtype">int</span>* verMajor, <span class="keywordtype">char</span>* verMinor)</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;{</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;    FILE* blfile = 0;</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;    fopen_s(&amp;blfile, bootName, <span class="stringliteral">&quot;rb&quot;</span>);</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;    blfile = fopen(bootName, <span class="stringliteral">&quot;rb&quot;</span>);</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;    <span class="keywordflow">if</span> (blfile == 0)</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;    fseek(blfile, 0x3DFC, SEEK_SET);</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ver_info[4];</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;    <span class="keywordtype">size_t</span> n = fread(ver_info, 1, 4, blfile);</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;    (void)n;</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;    fclose(blfile);</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;    <span class="comment">//Check for marker for valid version info</span></div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;    <span class="keywordflow">if</span> (ver_info[0] == 0xAA &amp;&amp; ver_info[1] == 0x55)</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    {</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;        <span class="keywordflow">if</span> (verMajor)</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;            *verMajor = ver_info[2];</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;        <span class="keywordflow">if</span> (verMinor)</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;            *verMinor = ver_info[3];</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;    }</div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;    <span class="comment">//No version found</span></div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;}</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> bootloadUpdateBootloaderSendFile(<a class="code" href="structbootload__params__t.html">bootload_params_t</a>* p)</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;{</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;    <span class="comment">//Setup serial port for correct baud rate</span></div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="serial_port_8c.html#a88df870918d4791ddaac45c562abf6cf">serialPortOpenRetry</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>-&gt;<a class="code" href="structserial__port__t.html#ae78066c31c9a5100228570d53e7fbec5">port</a>, <a class="code" href="serial_port_8h.html#acea5a86c00bb93e838804593843b30b7">BAUDRATE_115200</a>, 1))</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;    {</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Failed to open port.\n&quot;</span>);</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;        <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;    }</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;    <span class="comment">// https://github.com/atmelcorp/sam-ba/tree/master/src/plugins/connection/serial</span></div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;    <span class="comment">// https://sourceforge.net/p/lejos/wiki-nxt/SAM-BA%20Protocol/</span></div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[<a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>];</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;    uint32_t checksum = 0;</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;    <span class="comment">// try non-USB and then USB mode (0 and 1)</span></div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> isUSB = 0; isUSB &lt; 2; isUSB++)</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;    {</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;        <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, 250);</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;        <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="serial_port_8c.html#a88df870918d4791ddaac45c562abf6cf">serialPortOpenRetry</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>-&gt;<a class="code" href="structserial__port__t.html#ae78066c31c9a5100228570d53e7fbec5">port</a>, <a class="code" href="inertial_sense_boot_loader_8c.html#a97c6b46fb3f7fa2d7e62961e3f94d374">SAM_BA_BAUDRATE</a>, 1))</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;        {</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Failed to open port.\n&quot;</span>);</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;            <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;        }</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        <span class="comment">// flush</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;        <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, (<span class="keywordtype">void</span>*)<span class="stringliteral">&quot;#&quot;</span>, 2);</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;        <span class="keywordtype">int</span> count = <a class="code" href="serial_port_8c.html#a7426c48831273ec45889f652623d00df">serialPortReadTimeout</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, buf, <span class="keyword">sizeof</span>(buf), 100);</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;        <span class="comment">// non-interactive mode</span></div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;        count = <a class="code" href="serial_port_8c.html#af23d6a9f9842e06d1e974a265ff04edd">serialPortWriteAndWaitFor</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, (<span class="keywordtype">void</span>*)<span class="stringliteral">&quot;N#&quot;</span>, 2, (<span class="keywordtype">void</span>*)<span class="stringliteral">&quot;\n\r&quot;</span>, 2);</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;        <span class="keywordflow">if</span> (!count)</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;        {</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Failed to handshake with SAM-BA\n&quot;</span>);</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;            <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;        }</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;        <span class="comment">// set flash mode register</span></div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;        <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;W400e0c00,04000600#&quot;</span>, 19);</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;        FILE* file;</div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;        fopen_s(&amp;file, p-&gt;<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a>, <span class="stringliteral">&quot;rb&quot;</span>);</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;        file = fopen(p-&gt;<a class="code" href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">fileName</a>, <span class="stringliteral">&quot;rb&quot;</span>);</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;        <span class="keywordflow">if</span> (file == 0)</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;        {</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Unable to load bootloader file\n&quot;</span>);</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;            <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;        }</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;        fseek(file, 0, SEEK_END);</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;        <span class="keywordtype">int</span> size = ftell(file);</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;        fseek(file, 0, SEEK_SET);</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;        checksum = 0;</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;        <span class="keywordflow">if</span> (size != <a class="code" href="inertial_sense_boot_loader_8c.html#abac28520efbc61d0cb08abc48263753c">SAM_BA_BOOTLOADER_SIZE</a>)</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;        {</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;            <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Invalid bootloader file\n&quot;</span>);</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;            <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;            <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;        }</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;            p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;Writing bootloader...&quot;</span>);</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;        uint32_t offset = 0;</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        <span class="keywordflow">while</span> (fread(buf, 1, <a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>, file) == <a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>)</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;        {</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;            <span class="keywordflow">if</span> (!samBaFlashEraseWritePage(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, offset, buf, isUSB))</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;            {</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;                <span class="keywordflow">if</span> (!isUSB)</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;                {</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;                    offset = 0;</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;                    <span class="keywordflow">break</span>; <span class="comment">// try USB mode</span></div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;                }</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;                <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Failed to upload page at offset %d\n&quot;</span>, (<span class="keywordtype">int</span>)offset);</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;                <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;            }</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;            <span class="keywordflow">for</span> (uint32_t* ptr = (uint32_t*)buf, *ptrEnd = (uint32_t*)(buf + <span class="keyword">sizeof</span>(buf)); ptr &lt; ptrEnd; ptr++)</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;            {</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;                checksum ^= *ptr;</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;            }</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;            offset += <a class="code" href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a>;</div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;            <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a> != 0)</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;            {</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;                p-&gt;<a class="code" href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">uploadProgress</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, (<span class="keywordtype">float</span>)offset / (<span class="keywordtype">float</span>)<a class="code" href="inertial_sense_boot_loader_8c.html#abac28520efbc61d0cb08abc48263753c">SAM_BA_BOOTLOADER_SIZE</a>);</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;            }</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;        }</div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;        fclose(file);</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;        <span class="keywordflow">if</span> (offset != 0)</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;        {</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;            <span class="keywordflow">break</span>; <span class="comment">// success!</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;        }</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    }</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a> != 0)</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;    {</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;        <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>)</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;            p-&gt;<a class="code" href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">statusText</a>(p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, <span class="stringliteral">&quot;Verifying bootloader...&quot;</span>);</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;        <span class="keywordflow">switch</span> (samBaVerify(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>, checksum, p-&gt;<a class="code" href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">obj</a>, p-&gt;<a class="code" href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">verifyProgress</a>))</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;        {</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;        <span class="keywordflow">case</span> -1: <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Flash read error\n&quot;</span>); <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;        <span class="keywordflow">case</span> -2: <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Flash checksum error\n&quot;</span>); <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;        }</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    }</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;    <span class="keywordflow">if</span> (!samBaSetBootFromFlash(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>))</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    {</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Failed to set boot from flash GPNVM bit\n&quot;</span>);</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;        <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    }</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;    <span class="keywordflow">if</span> (!samBaSoftReset(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>))</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;    {</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;        <a class="code" href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a>(p, <span class="stringliteral">&quot;Failed to reset device\n&quot;</span>);</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;        <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    }</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(p-&gt;<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a>);</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;}</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;</div><div class="line"><a name="l01760"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8h.html#a98c0ef9d938083384803b4d7d90d3373"> 1760</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="inertial_sense_boot_loader_8c.html#a98c0ef9d938083384803b4d7d90d3373">enableBootloader</a>(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port, <span class="keywordtype">int</span> baudRate, <span class="keywordtype">char</span>* error, <span class="keywordtype">int</span> errorLength, <span class="keyword">const</span> <span class="keywordtype">char</span>* bootloadEnableCmd)</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;{</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;    <span class="keywordtype">int</span> baudRates[] = { baudRate, <a class="code" href="inertial_sense_boot_loader_8h.html#a9be7e1b986a632f484f90d4a62b93489">IS_BAUD_RATE_BOOTLOADER</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#a7012a6cc174590fc4e38331c34c5d63d">IS_BAUD_RATE_BOOTLOADER_RS232</a>, <a class="code" href="inertial_sense_boot_loader_8h.html#a3dd40c53dede7af6b3ef8ac95805fd41">IS_BAUD_RATE_BOOTLOADER_SLOW</a> };</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;    <span class="comment">// detect if device is already in bootloader mode</span></div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;    <a class="code" href="structbootload__params__t.html">bootload_params_t</a> p;</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;    memset(&amp;p, 0, <span class="keyword">sizeof</span>(p));</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;    p.<a class="code" href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">port</a> = port;</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;    p.<a class="code" href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">baudRate</a> = <a class="code" href="inertial_sense_boot_loader_8c.html#abc522a3dc48d8eec055d0ce46e86af48">bootloaderClosestBaudRate</a>(baudRate);</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;    <span class="comment">// attempt to handshake in case we are in bootloader mode</span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    <span class="comment">//When we handshake with legacy bootloader baudrate it prevents us from entering the bootloader when the uINS is running its firmware.</span></div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;    <span class="comment">//Instead of checking for the bootloader first, we will send the command to enter the bootloader without checking.</span></div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;    <span class="comment">//After the command is sent, it will try to handsake again and will find the bootloader even if the bootloader is alreay running before sending the command to enter.</span></div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;    <span class="comment">//if (!bootloaderHandshake(&amp;p))</span></div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;    {</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;        <span class="comment">// in case we are in program mode, try and send the commands to go into bootloader mode</span></div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c = 0;</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; <a class="code" href="_i_s_constants_8h.html#ae165d3d36e78851434995cd9e9fc8d78">_ARRAY_ELEMENT_COUNT</a>(baudRates); i++)</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;        {</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;            <span class="keywordflow">if</span> (baudRates[i] == 0)</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;            <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(port);</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;            <span class="keywordflow">if</span> (serialPortOpenInternal(port, baudRates[i], error, errorLength) == 0)</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;            {</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;                <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(port);</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;                <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;            }</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> loop = 0; loop &lt; 10; loop++)</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;            {</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;                <a class="code" href="serial_port_8c.html#a85e247f1f47c653e9d44c2c049c7ce55">serialPortWriteAscii</a>(port, <span class="stringliteral">&quot;STPB&quot;</span>, 4);</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;                <a class="code" href="serial_port_8c.html#a85e247f1f47c653e9d44c2c049c7ce55">serialPortWriteAscii</a>(port, bootloadEnableCmd, 4);</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;                c = 0;</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="serial_port_8c.html#a3cb89cb0314c641149ddefc46dd1f94d">serialPortReadCharTimeout</a>(port, &amp;c, 13) == 1)</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;                {</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;                    <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;$&#39;</span>)</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;                    {</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;                        <span class="comment">// done, we got into bootloader mode</span></div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;                        i = 9999;</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;                    }</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;                }</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;                {</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;                    <a class="code" href="serial_port_8c.html#af4b519e1c32d49d8937677b4b62ea99d">serialPortFlush</a>(port);</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;                }</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;            }</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;        }</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;        <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(port);</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;        <a class="code" href="_i_s_utilities_8h.html#a038783cd27cbb54e9c8d8708f147168e">SLEEP_MS</a>(<a class="code" href="inertial_sense_boot_loader_8h.html#a36f9c553bf1daf7c7df99886e2f0eaa0">BOOTLOADER_REFRESH_DELAY</a>);</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;        <span class="comment">// if we can&#39;t handshake at this point, bootloader enable has failed</span></div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;        <span class="keywordflow">if</span> (!bootloaderHandshake(&amp;p))</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;        {</div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;            <span class="comment">// failure</span></div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;            <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(port);</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;            <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;        }</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;    }</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;    <span class="comment">// ensure bootloader restarts in fresh state</span></div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;    bootloaderRestart(port);</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;    <span class="comment">// by this point the bootloader should be enabled</span></div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;    <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(port);</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;}</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> disableBootloaderInternal(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port, <span class="keywordtype">char</span>* error, <span class="keywordtype">int</span> errorLength, <span class="keywordtype">int</span> baud)</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;{</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    <span class="comment">// open the serial port</span></div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    <span class="keywordflow">if</span> (serialPortOpenInternal(port, baud, error, errorLength) == 0)</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;    {</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;    }</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;    <span class="comment">// send the &quot;reboot to program mode&quot; command and the device should start in program mode</span></div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;    <a class="code" href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a>(port, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="stringliteral">&quot;:020000040300F7&quot;</span>, 15);</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    <a class="code" href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a>(port, 250);</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;    <a class="code" href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a>(port);</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;}</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;</div><div class="line"><a name="l01846"></a><span class="lineno"><a class="line" href="inertial_sense_boot_loader_8h.html#a1ba2459e76f174c6fed632130578a487"> 1846</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="inertial_sense_boot_loader_8c.html#a1ba2459e76f174c6fed632130578a487">disableBootloader</a>(<a class="code" href="structserial__port__t.html">serial_port_t</a>* port, <span class="keywordtype">char</span>* error, <span class="keywordtype">int</span> errorLength)</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;{</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;    <span class="keywordtype">int</span> result = -1;</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    result &amp;= disableBootloaderInternal(port, error, errorLength, <a class="code" href="inertial_sense_boot_loader_8h.html#a9be7e1b986a632f484f90d4a62b93489">IS_BAUD_RATE_BOOTLOADER</a>);</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    result &amp;= disableBootloaderInternal(port, error, errorLength, <a class="code" href="inertial_sense_boot_loader_8h.html#a7012a6cc174590fc4e38331c34c5d63d">IS_BAUD_RATE_BOOTLOADER_RS232</a>);</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;    result &amp;= disableBootloaderInternal(port, error, errorLength, <a class="code" href="inertial_sense_boot_loader_8h.html#a3dd40c53dede7af6b3ef8ac95805fd41">IS_BAUD_RATE_BOOTLOADER_SLOW</a>);</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    <span class="keywordflow">return</span> result;</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;}</div><div class="ttc" id="serial_port_8c_html_a8c06177e7cce0225011a591265ad3517"><div class="ttname"><a href="serial_port_8c.html#a8c06177e7cce0225011a591265ad3517">serialPortSleep</a></div><div class="ttdeci">int serialPortSleep(serial_port_t *serialPort, int sleepMilliseconds)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00349">serialPort.c:349</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_ac8d2f33ea59110e28863a4c5516148e8"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#ac8d2f33ea59110e28863a4c5516148e8">bootloadFile</a></div><div class="ttdeci">int bootloadFile(serial_port_t *port, const char *fileName, const char *bootName, const void *obj, pfnBootloadProgress uploadProgress, pfnBootloadProgress verifyProgress)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l01479">inertialSenseBootLoader.c:1479</a></div></div>
<div class="ttc" id="structbootloader__state__t_html_ad8f97f283b3d9ce5c9885a1adb1e0f74"><div class="ttname"><a href="structbootloader__state__t.html#ad8f97f283b3d9ce5c9885a1adb1e0f74">bootloader_state_t::param</a></div><div class="ttdeci">bootload_params_t * param</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00045">inertialSenseBootLoader.c:45</a></div></div>
<div class="ttc" id="serial_port_8c_html_af4b519e1c32d49d8937677b4b62ea99d"><div class="ttname"><a href="serial_port_8c.html#af4b519e1c32d49d8937677b4b62ea99d">serialPortFlush</a></div><div class="ttdeci">int serialPortFlush(serial_port_t *serialPort)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00075">serialPort.c:75</a></div></div>
<div class="ttc" id="_i_s_utilities_8h_html_a038783cd27cbb54e9c8d8708f147168e"><div class="ttname"><a href="_i_s_utilities_8h.html#a038783cd27cbb54e9c8d8708f147168e">SLEEP_MS</a></div><div class="ttdeci">#define SLEEP_MS(timeMs)</div><div class="ttdef"><b>Definition:</b> <a href="_i_s_utilities_8h_source.html#l00143">ISUtilities.h:143</a></div></div>
<div class="ttc" id="structbootloader__state__t_html_a5349b92ca1d8e6d4c7849c81cfce6e44"><div class="ttname"><a href="structbootloader__state__t.html#a5349b92ca1d8e6d4c7849c81cfce6e44">bootloader_state_t::verifyChunkSize</a></div><div class="ttdeci">int verifyChunkSize</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00044">inertialSenseBootLoader.c:44</a></div></div>
<div class="ttc" id="structbootloader__state__t_html_af58dbc48069cacc60ecaa109dcf64392"><div class="ttname"><a href="structbootloader__state__t.html#af58dbc48069cacc60ecaa109dcf64392">bootloader_state_t::firstPageSkipBytes</a></div><div class="ttdeci">int firstPageSkipBytes</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00043">inertialSenseBootLoader.c:43</a></div></div>
<div class="ttc" id="serial_port_8c_html_ad2240e52502e49f931504565cc1d39d0"><div class="ttname"><a href="serial_port_8c.html#ad2240e52502e49f931504565cc1d39d0">serialPortWrite</a></div><div class="ttdeci">int serialPortWrite(serial_port_t *serialPort, const unsigned char *buffer, int writeCount)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00201">serialPort.c:201</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_abac28520efbc61d0cb08abc48263753c"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#abac28520efbc61d0cb08abc48263753c">SAM_BA_BOOTLOADER_SIZE</a></div><div class="ttdeci">#define SAM_BA_BOOTLOADER_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00025">inertialSenseBootLoader.c:25</a></div></div>
<div class="ttc" id="_i_s_constants_8h_html_a89279935d2e2d0bcdc26cdf9e2ba5b1e"><div class="ttname"><a href="_i_s_constants_8h.html#a89279935d2e2d0bcdc26cdf9e2ba5b1e">_MIN</a></div><div class="ttdeci">#define _MIN(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="_i_s_constants_8h_source.html#l00301">ISConstants.h:301</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a0fb19b81296391f0e36ba02b0a85d485"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a0fb19b81296391f0e36ba02b0a85d485">bootloadFileEx</a></div><div class="ttdeci">int bootloadFileEx(bootload_params_t *params)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l01498">inertialSenseBootLoader.c:1498</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a63f210cda6f586f405e57570647007fb"><div class="ttname"><a href="structbootload__params__t.html#a63f210cda6f586f405e57570647007fb">bootload_params_t::flags</a></div><div class="ttdeci">union bootload_params_t::@2 flags</div></div>
<div class="ttc" id="structbootloader__state__t_html_abbaaea17b31dcecfd7f5e9b9548d1626"><div class="ttname"><a href="structbootloader__state__t.html#abbaaea17b31dcecfd7f5e9b9548d1626">bootloader_state_t::version</a></div><div class="ttdeci">int version</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00042">inertialSenseBootLoader.c:42</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a4c548c41044465fad00d24c99eeced77"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a4c548c41044465fad00d24c99eeced77">MAX_VERIFY_CHUNK_SIZE</a></div><div class="ttdeci">#define MAX_VERIFY_CHUNK_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00020">inertialSenseBootLoader.c:20</a></div></div>
<div class="ttc" id="serial_port_8c_html_a3cb89cb0314c641149ddefc46dd1f94d"><div class="ttname"><a href="serial_port_8c.html#a3cb89cb0314c641149ddefc46dd1f94d">serialPortReadCharTimeout</a></div><div class="ttdeci">int serialPortReadCharTimeout(serial_port_t *serialPort, unsigned char *c, int timeoutMilliseconds)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00196">serialPort.c:196</a></div></div>
<div class="ttc" id="structxmodem__chunk__t_html_a7a2ab607af54ab9ea0dc8606350b916b"><div class="ttname"><a href="structxmodem__chunk__t.html#a7a2ab607af54ab9ea0dc8606350b916b">xmodem_chunk_t::start</a></div><div class="ttdeci">uint8_t start</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00052">inertialSenseBootLoader.c:52</a></div></div>
<div class="ttc" id="structxmodem__chunk__t_html_af7eb843c4fbc37134142cf71271f1e42"><div class="ttname"><a href="structxmodem__chunk__t.html#af7eb843c4fbc37134142cf71271f1e42">xmodem_chunk_t::payload</a></div><div class="ttdeci">uint8_t payload[XMODEM_PAYLOAD_SIZE]</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00055">inertialSenseBootLoader.c:55</a></div></div>
<div class="ttc" id="serial_port_8h_html_acea5a86c00bb93e838804593843b30b7"><div class="ttname"><a href="serial_port_8h.html#acea5a86c00bb93e838804593843b30b7">BAUDRATE_115200</a></div><div class="ttdeci">#define BAUDRATE_115200</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8h_source.html#l00038">serialPort.h:38</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a4cc14e2c99ae7f8e5a8e371d03c8532c"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a4cc14e2c99ae7f8e5a8e371d03c8532c">FLASH_PAGE_SIZE</a></div><div class="ttdeci">#define FLASH_PAGE_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00036">inertialSenseBootLoader.c:36</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a4c1c7377d676d6e2f1b266f558e1c7f7"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a4c1c7377d676d6e2f1b266f558e1c7f7">X_NAK</a></div><div class="ttdeci">#define X_NAK</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00030">inertialSenseBootLoader.c:30</a></div></div>
<div class="ttc" id="_i_s_constants_8h_html_a2149ebad4d6576b844e9c8ec46e63247"><div class="ttname"><a href="_i_s_constants_8h.html#a2149ebad4d6576b844e9c8ec46e63247">POP_PACK</a></div><div class="ttdeci">#define POP_PACK</div><div class="ttdef"><b>Definition:</b> <a href="_i_s_constants_8h_source.html#l00237">ISConstants.h:237</a></div></div>
<div class="ttc" id="structbootload__params__t_html_aef1cbbb5011e6b966f4b8333506091ee"><div class="ttname"><a href="structbootload__params__t.html#aef1cbbb5011e6b966f4b8333506091ee">bootload_params_t::bitFields</a></div><div class="ttdeci">struct bootload_params_t::@2::@3 bitFields</div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a676b4a362ff2f2909cf5e47805548daa"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a676b4a362ff2f2909cf5e47805548daa">bootloader_snprintf</a></div><div class="ttdeci">#define bootloader_snprintf</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00067">inertialSenseBootLoader.c:67</a></div></div>
<div class="ttc" id="structbootloader__state__t_html"><div class="ttname"><a href="structbootloader__state__t.html">bootloader_state_t</a></div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00040">inertialSenseBootLoader.c:40</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a4732b6933d4d4dfcf6beeef8994ac2c5"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a4732b6933d4d4dfcf6beeef8994ac2c5">SAM_BA_FLASH_PAGE_SIZE</a></div><div class="ttdeci">#define SAM_BA_FLASH_PAGE_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00023">inertialSenseBootLoader.c:23</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a377d602dd57c98be59f66efafe93a924"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a377d602dd57c98be59f66efafe93a924">BOOTLOADER_TIMEOUT_DEFAULT</a></div><div class="ttdeci">#define BOOTLOADER_TIMEOUT_DEFAULT</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00021">inertialSenseBootLoader.c:21</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a9bab5e89643dedb225c44447a84b4eab"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a9bab5e89643dedb225c44447a84b4eab">SAM_BA_FLASH_START_ADDRESS</a></div><div class="ttdeci">#define SAM_BA_FLASH_START_ADDRESS</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00024">inertialSenseBootLoader.c:24</a></div></div>
<div class="ttc" id="serial_port_8c_html_a41dbe152baba9cab417513fd8289a9a6"><div class="ttname"><a href="serial_port_8c.html#a41dbe152baba9cab417513fd8289a9a6">serialPortRead</a></div><div class="ttdeci">int serialPortRead(serial_port_t *serialPort, unsigned char *buffer, int readCount)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00084">serialPort.c:84</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_abc522a3dc48d8eec055d0ce46e86af48"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#abc522a3dc48d8eec055d0ce46e86af48">bootloaderClosestBaudRate</a></div><div class="ttdeci">int bootloaderClosestBaudRate(int baudRate)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00220">inertialSenseBootLoader.c:220</a></div></div>
<div class="ttc" id="structxmodem__chunk__t_html_a54cbea1a5a2bf6d38f3fdd4dc1210588"><div class="ttname"><a href="structxmodem__chunk__t.html#a54cbea1a5a2bf6d38f3fdd4dc1210588">xmodem_chunk_t::block</a></div><div class="ttdeci">uint8_t block</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00053">inertialSenseBootLoader.c:53</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a97c6b46fb3f7fa2d7e62961e3f94d374"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a97c6b46fb3f7fa2d7e62961e3f94d374">SAM_BA_BAUDRATE</a></div><div class="ttdeci">#define SAM_BA_BAUDRATE</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00022">inertialSenseBootLoader.c:22</a></div></div>
<div class="ttc" id="structbootload__params__t_html"><div class="ttname"><a href="structbootload__params__t.html">bootload_params_t</a></div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00053">inertialSenseBootLoader.h:53</a></div></div>
<div class="ttc" id="_i_s_constants_8h_html_a5cf8424fec96baad5919dfb1c4a8dc71"><div class="ttname"><a href="_i_s_constants_8h.html#a5cf8424fec96baad5919dfb1c4a8dc71">PUSH_PACK_1</a></div><div class="ttdeci">#define PUSH_PACK_1</div><div class="ttdef"><b>Definition:</b> <a href="_i_s_constants_8h_source.html#l00234">ISConstants.h:234</a></div></div>
<div class="ttc" id="_i_s_utilities_8h_html"><div class="ttname"><a href="_i_s_utilities_8h.html">ISUtilities.h</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html_a3dd40c53dede7af6b3ef8ac95805fd41"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html#a3dd40c53dede7af6b3ef8ac95805fd41">IS_BAUD_RATE_BOOTLOADER_SLOW</a></div><div class="ttdeci">#define IS_BAUD_RATE_BOOTLOADER_SLOW</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00029">inertialSenseBootLoader.h:29</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html_ab22aca14c8a64bf08273664ce796c2d5"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html#ab22aca14c8a64bf08273664ce796c2d5">BOOTLOADER_ERROR_LENGTH</a></div><div class="ttdeci">#define BOOTLOADER_ERROR_LENGTH</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00044">inertialSenseBootLoader.h:44</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html_af3960f600015ba067228d38c25f178f0"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html#af3960f600015ba067228d38c25f178f0">pfnBootloadProgress</a></div><div class="ttdeci">int(* pfnBootloadProgress)(const void *obj, float percent)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00048">inertialSenseBootLoader.h:48</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_ace562d0cb6579fea3bd3fd1da60e0a4f"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#ace562d0cb6579fea3bd3fd1da60e0a4f">X_ACK</a></div><div class="ttdeci">#define X_ACK</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00029">inertialSenseBootLoader.c:29</a></div></div>
<div class="ttc" id="serial_port_8c_html_a25ebaeafcc060a447ec1a38a8085943d"><div class="ttname"><a href="serial_port_8c.html#a25ebaeafcc060a447ec1a38a8085943d">serialPortClose</a></div><div class="ttdeci">int serialPortClose(serial_port_t *serialPort)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00066">serialPort.c:66</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html_a36f9c553bf1daf7c7df99886e2f0eaa0"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html#a36f9c553bf1daf7c7df99886e2f0eaa0">BOOTLOADER_REFRESH_DELAY</a></div><div class="ttdeci">#define BOOTLOADER_REFRESH_DELAY</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00035">inertialSenseBootLoader.h:35</a></div></div>
<div class="ttc" id="_i_s_constants_8h_html_ae89189d0a7577e6b18155b6865077b85"><div class="ttname"><a href="_i_s_constants_8h.html#ae89189d0a7577e6b18155b6865077b85">SWAP16</a></div><div class="ttdeci">#define SWAP16(v)</div><div class="ttdef"><b>Definition:</b> <a href="_i_s_constants_8h_source.html#l00268">ISConstants.h:268</a></div></div>
<div class="ttc" id="structxmodem__chunk__t_html_a08365679b65dbfa8c81f293fcd8f36bc"><div class="ttname"><a href="structxmodem__chunk__t.html#a08365679b65dbfa8c81f293fcd8f36bc">xmodem_chunk_t::block_neg</a></div><div class="ttdeci">uint8_t block_neg</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00054">inertialSenseBootLoader.c:54</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_af29610e6a77c6fc7976737ab667cbca2"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#af29610e6a77c6fc7976737ab667cbca2">bootloadGetBootloaderVersionFromFile</a></div><div class="ttdeci">int bootloadGetBootloaderVersionFromFile(const char *bootName, int *verMajor, char *verMinor)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l01584">inertialSenseBootLoader.c:1584</a></div></div>
<div class="ttc" id="structbootload__params__t_html_accd28a17ec2d3b1b8123a8af0428bdd6"><div class="ttname"><a href="structbootload__params__t.html#accd28a17ec2d3b1b8123a8af0428bdd6">bootload_params_t::obj</a></div><div class="ttdeci">const void * obj</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00060">inertialSenseBootLoader.h:60</a></div></div>
<div class="ttc" id="serial_port_8c_html_af23d6a9f9842e06d1e974a265ff04edd"><div class="ttname"><a href="serial_port_8c.html#af23d6a9f9842e06d1e974a265ff04edd">serialPortWriteAndWaitFor</a></div><div class="ttdeci">int serialPortWriteAndWaitFor(serial_port_t *serialPort, const unsigned char *buffer, int writeCount, const unsigned char *waitFor, int waitForLength)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00281">serialPort.c:281</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html_ae9af5fb05b7c83d516ab4683ca1faf86"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html#ae9af5fb05b7c83d516ab4683ca1faf86">BOOTLOADER_RESPONSE_DELAY</a></div><div class="ttdeci">#define BOOTLOADER_RESPONSE_DELAY</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00036">inertialSenseBootLoader.h:36</a></div></div>
<div class="ttc" id="structserial__port__t_html_ae78066c31c9a5100228570d53e7fbec5"><div class="ttname"><a href="structserial__port__t.html#ae78066c31c9a5100228570d53e7fbec5">serial_port_t::port</a></div><div class="ttdeci">char port[MAX_SERIAL_PORT_NAME_LENGTH+1]</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8h_source.html#l00070">serialPort.h:70</a></div></div>
<div class="ttc" id="serial_port_8c_html_a7426c48831273ec45889f652623d00df"><div class="ttname"><a href="serial_port_8c.html#a7426c48831273ec45889f652623d00df">serialPortReadTimeout</a></div><div class="ttdeci">int serialPortReadTimeout(serial_port_t *serialPort, unsigned char *buffer, int readCount, int timeoutMilliseconds)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00089">serialPort.c:89</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a24f112ce5750a485a5679c51e45fa664"><div class="ttname"><a href="structbootload__params__t.html#a24f112ce5750a485a5679c51e45fa664">bootload_params_t::verifyFileName</a></div><div class="ttdeci">const char * verifyFileName</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00064">inertialSenseBootLoader.h:64</a></div></div>
<div class="ttc" id="serial_port_8c_html_a88df870918d4791ddaac45c562abf6cf"><div class="ttname"><a href="serial_port_8c.html#a88df870918d4791ddaac45c562abf6cf">serialPortOpenRetry</a></div><div class="ttdeci">int serialPortOpenRetry(serial_port_t *serialPort, const char *port, int baudRate, int blocking)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00037">serialPort.c:37</a></div></div>
<div class="ttc" id="structserial__port__t_html_a8c767fdb868bc53e63afca6d0dbaae1d"><div class="ttname"><a href="structserial__port__t.html#a8c767fdb868bc53e63afca6d0dbaae1d">serial_port_t::error</a></div><div class="ttdeci">char * error</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8h_source.html#l00073">serialPort.h:73</a></div></div>
<div class="ttc" id="structxmodem__chunk__t_html_ac8e4ae3c656fb62e025100bcb3be1af7"><div class="ttname"><a href="structxmodem__chunk__t.html#ac8e4ae3c656fb62e025100bcb3be1af7">xmodem_chunk_t::crc</a></div><div class="ttdeci">uint16_t crc</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00056">inertialSenseBootLoader.c:56</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a9944ba87605cde45e912eaa92a37f480"><div class="ttname"><a href="structbootload__params__t.html#a9944ba87605cde45e912eaa92a37f480">bootload_params_t::uploadProgress</a></div><div class="ttdeci">pfnBootloadProgress uploadProgress</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00061">inertialSenseBootLoader.h:61</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a1ba2459e76f174c6fed632130578a487"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a1ba2459e76f174c6fed632130578a487">disableBootloader</a></div><div class="ttdeci">int disableBootloader(serial_port_t *port, char *error, int errorLength)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l01846">inertialSenseBootLoader.c:1846</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a828559991c62edd71cbe0bd8034087bb"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a828559991c62edd71cbe0bd8034087bb">XMODEM_PAYLOAD_SIZE</a></div><div class="ttdeci">#define XMODEM_PAYLOAD_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00033">inertialSenseBootLoader.c:33</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html_a7012a6cc174590fc4e38331c34c5d63d"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html#a7012a6cc174590fc4e38331c34c5d63d">IS_BAUD_RATE_BOOTLOADER_RS232</a></div><div class="ttdeci">#define IS_BAUD_RATE_BOOTLOADER_RS232</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00026">inertialSenseBootLoader.h:26</a></div></div>
<div class="ttc" id="structserial__port__t_html_a2884da85ca80486926080009e7624315"><div class="ttname"><a href="structserial__port__t.html#a2884da85ca80486926080009e7624315">serial_port_t::errorLength</a></div><div class="ttdeci">int errorLength</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8h_source.html#l00076">serialPort.h:76</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a4cd007a6c3a06662496716821f36e827"><div class="ttname"><a href="structbootload__params__t.html#a4cd007a6c3a06662496716821f36e827">bootload_params_t::statusText</a></div><div class="ttdeci">pfnBootloadStatus statusText</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00063">inertialSenseBootLoader.h:63</a></div></div>
<div class="ttc" id="serial_port_8c_html_a85e247f1f47c653e9d44c2c049c7ce55"><div class="ttname"><a href="serial_port_8c.html#a85e247f1f47c653e9d44c2c049c7ce55">serialPortWriteAscii</a></div><div class="ttdeci">int serialPortWriteAscii(serial_port_t *serialPort, const char *buffer, int bufferLength)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00230">serialPort.c:230</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a6821bafc3c88dfb2e433a095df9940c6"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a6821bafc3c88dfb2e433a095df9940c6">BUF_SIZE</a></div><div class="ttdeci">#define BUF_SIZE</div></div>
<div class="ttc" id="structserial__port__t_html"><div class="ttname"><a href="structserial__port__t.html">serial_port_t</a></div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8h_source.html#l00064">serialPort.h:64</a></div></div>
<div class="ttc" id="structxmodem__chunk__t_html"><div class="ttname"><a href="structxmodem__chunk__t.html">xmodem_chunk_t</a></div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00050">inertialSenseBootLoader.c:50</a></div></div>
<div class="ttc" id="serial_port_8c_html_aaef9e6973f9dfd121a4eb87b7a13542e"><div class="ttname"><a href="serial_port_8c.html#aaef9e6973f9dfd121a4eb87b7a13542e">serialPortWaitForTimeout</a></div><div class="ttdeci">int serialPortWaitForTimeout(serial_port_t *serialPort, const unsigned char *waitFor, int waitForLength, int timeoutMilliseconds)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00308">serialPort.c:308</a></div></div>
<div class="ttc" id="structbootload__params__t_html_ab54a508e41f043f06f7170ecfd1f674b"><div class="ttname"><a href="structbootload__params__t.html#ab54a508e41f043f06f7170ecfd1f674b">bootload_params_t::port</a></div><div class="ttdeci">serial_port_t * port</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00058">inertialSenseBootLoader.h:58</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a79d61db431a37f9654345a1b7816bd62"><div class="ttname"><a href="structbootload__params__t.html#a79d61db431a37f9654345a1b7816bd62">bootload_params_t::error</a></div><div class="ttdeci">char error[BOOTLOADER_ERROR_LENGTH]</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00059">inertialSenseBootLoader.h:59</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_ab2b7c4df2c8e87dcbb5c9fe87dfd5192"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#ab2b7c4df2c8e87dcbb5c9fe87dfd5192">bootloaderCycleBaudRate</a></div><div class="ttdeci">int bootloaderCycleBaudRate(int baudRate)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00202">inertialSenseBootLoader.c:202</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html_a9be7e1b986a632f484f90d4a62b93489"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html#a9be7e1b986a632f484f90d4a62b93489">IS_BAUD_RATE_BOOTLOADER</a></div><div class="ttdeci">#define IS_BAUD_RATE_BOOTLOADER</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00023">inertialSenseBootLoader.h:23</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a98c0ef9d938083384803b4d7d90d3373"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a98c0ef9d938083384803b4d7d90d3373">enableBootloader</a></div><div class="ttdeci">int enableBootloader(serial_port_t *port, int baudRate, char *error, int errorLength, const char *bootloadEnableCmd)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l01760">inertialSenseBootLoader.c:1760</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html_a94bf881abdc00f884f3580b5b7823ede"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html#a94bf881abdc00f884f3580b5b7823ede">BOOTLOADER_RETRIES</a></div><div class="ttdeci">#define BOOTLOADER_RETRIES</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00038">inertialSenseBootLoader.h:38</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a6b20d41d6252e9871430c242cb1a56e7"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a6b20d41d6252e9871430c242cb1a56e7">BUFFER_SIZE</a></div><div class="ttdeci">#define BUFFER_SIZE</div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a9f2d5fb9b4f02d9e5c7627bb1195c856"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a9f2d5fb9b4f02d9e5c7627bb1195c856">bootloader_min</a></div><div class="ttdeci">#define bootloader_min(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00077">inertialSenseBootLoader.c:77</a></div></div>
<div class="ttc" id="_i_s_constants_8h_html_a770571e12ff9370899184528f4b4626d"><div class="ttname"><a href="_i_s_constants_8h.html#a770571e12ff9370899184528f4b4626d">SNPRINTF</a></div><div class="ttdeci">#define SNPRINTF</div><div class="ttdef"><b>Definition:</b> <a href="_i_s_constants_8h_source.html#l00148">ISConstants.h:148</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a6260fbddc4df59f2e92d06ef33120d9d"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a6260fbddc4df59f2e92d06ef33120d9d">X_EOT</a></div><div class="ttdeci">#define X_EOT</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00028">inertialSenseBootLoader.c:28</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_ae25458f6abaf963108f26ee9168485ac"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#ae25458f6abaf963108f26ee9168485ac">bootloader_perror</a></div><div class="ttdeci">#define bootloader_perror(s,...)</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00071">inertialSenseBootLoader.c:71</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a3a57af5c3275b2f53fa64274b11e8d52"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a3a57af5c3275b2f53fa64274b11e8d52">CRC_POLY</a></div><div class="ttdeci">#define CRC_POLY</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00032">inertialSenseBootLoader.c:32</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a5ec11ef11aace0f302a1ea711388a28b"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a5ec11ef11aace0f302a1ea711388a28b">MAX_SEND_COUNT</a></div><div class="ttdeci">#define MAX_SEND_COUNT</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00019">inertialSenseBootLoader.c:19</a></div></div>
<div class="ttc" id="serial_port_8c_html_a714672a76f64069f76e025ec8d2fc66a"><div class="ttname"><a href="serial_port_8c.html#a714672a76f64069f76e025ec8d2fc66a">serialPortReadChar</a></div><div class="ttdeci">int serialPortReadChar(serial_port_t *serialPort, unsigned char *c)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00191">serialPort.c:191</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a0d32da48ece6e00d21a5b7be5c84a31d"><div class="ttname"><a href="structbootload__params__t.html#a0d32da48ece6e00d21a5b7be5c84a31d">bootload_params_t::bootloadEnableCmd</a></div><div class="ttdeci">char bootloadEnableCmd[16]</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00075">inertialSenseBootLoader.h:75</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a6cdc14dfbcd28d03c3c68bf965f43720"><div class="ttname"><a href="structbootload__params__t.html#a6cdc14dfbcd28d03c3c68bf965f43720">bootload_params_t::forceBootloaderUpdate</a></div><div class="ttdeci">int forceBootloaderUpdate</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00057">inertialSenseBootLoader.h:57</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a109fdd7e1e85478913e70bf73ec46f80"><div class="ttname"><a href="structbootload__params__t.html#a109fdd7e1e85478913e70bf73ec46f80">bootload_params_t::bootName</a></div><div class="ttdeci">const char * bootName</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00056">inertialSenseBootLoader.h:56</a></div></div>
<div class="ttc" id="_i_s_constants_8h_html_ae165d3d36e78851434995cd9e9fc8d78"><div class="ttname"><a href="_i_s_constants_8h.html#ae165d3d36e78851434995cd9e9fc8d78">_ARRAY_ELEMENT_COUNT</a></div><div class="ttdeci">#define _ARRAY_ELEMENT_COUNT(a)</div><div class="ttdef"><b>Definition:</b> <a href="_i_s_constants_8h_source.html#l00329">ISConstants.h:329</a></div></div>
<div class="ttc" id="serial_port_8c_html_a315998701c41541c53f4041b4e3f8403"><div class="ttname"><a href="serial_port_8c.html#a315998701c41541c53f4041b4e3f8403">serialPortWriteAndWaitForTimeout</a></div><div class="ttdeci">int serialPortWriteAndWaitForTimeout(serial_port_t *serialPort, const unsigned char *buffer, int writeCount, const unsigned char *waitFor, int waitForLength, const int timeoutMilliseconds)</div><div class="ttdef"><b>Definition:</b> <a href="serial_port_8c_source.html#l00286">serialPort.c:286</a></div></div>
<div class="ttc" id="structbootload__params__t_html_af97213f739b02a4201fde4ce3a2727e4"><div class="ttname"><a href="structbootload__params__t.html#af97213f739b02a4201fde4ce3a2727e4">bootload_params_t::verifyProgress</a></div><div class="ttdeci">pfnBootloadProgress verifyProgress</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00062">inertialSenseBootLoader.h:62</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html">inertialSenseBootLoader.h</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a9503237f9c9e527a60158ee62822ab76"><div class="ttname"><a href="structbootload__params__t.html#a9503237f9c9e527a60158ee62822ab76">bootload_params_t::numberOfDevices</a></div><div class="ttdeci">int numberOfDevices</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00065">inertialSenseBootLoader.h:65</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a1367e9ae908165cc92e4eeb9f164527b"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a1367e9ae908165cc92e4eeb9f164527b">X_CAN</a></div><div class="ttdeci">#define X_CAN</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00031">inertialSenseBootLoader.c:31</a></div></div>
<div class="ttc" id="structbootload__params__t_html_a239112373f6613392f1a0726b06045b4"><div class="ttname"><a href="structbootload__params__t.html#a239112373f6613392f1a0726b06045b4">bootload_params_t::baudRate</a></div><div class="ttdeci">int baudRate</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00066">inertialSenseBootLoader.h:66</a></div></div>
<div class="ttc" id="structbootload__params__t_html_aaf15845418f5104ce25c00114557ec90"><div class="ttname"><a href="structbootload__params__t.html#aaf15845418f5104ce25c00114557ec90">bootload_params_t::fileName</a></div><div class="ttdeci">const char * fileName</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00055">inertialSenseBootLoader.h:55</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8c_html_a20f86ac37b1c9b112cbfd1bfc0598c71"><div class="ttname"><a href="inertial_sense_boot_loader_8c.html#a20f86ac37b1c9b112cbfd1bfc0598c71">X_SOH</a></div><div class="ttdeci">#define X_SOH</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8c_source.html#l00027">inertialSenseBootLoader.c:27</a></div></div>
<div class="ttc" id="inertial_sense_boot_loader_8h_html_a404c96d6000a762c614a00847fd6a821"><div class="ttname"><a href="inertial_sense_boot_loader_8h.html#a404c96d6000a762c614a00847fd6a821">IS_BAUD_RATE_BOOTLOADER_LEGACY</a></div><div class="ttdeci">#define IS_BAUD_RATE_BOOTLOADER_LEGACY</div><div class="ttdef"><b>Definition:</b> <a href="inertial_sense_boot_loader_8h_source.html#l00032">inertialSenseBootLoader.h:32</a></div></div>
<div class="ttc" id="_i_s_constants_8h_html"><div class="ttname"><a href="_i_s_constants_8h.html">ISConstants.h</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
